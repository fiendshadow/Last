<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–ª–∞–Ω —Ö–∏—Ñ–∑–∞ ‚Äî –º–µ—Ç–æ–¥ 5 –∫—Ä–µ–ø–æ—Å—Ç–µ–π</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary: #1a6b4a;
            --primary-light: #2d9d6f;
            --primary-dark: #0f4a33;
            --gold: #d4a934;
            --gold-light: #f0d680;
            --gold-dark: #b08a1a;
            --bg: #f0f4f2;
            --card-bg: #ffffff;
            --text: #1a2a24;
            --text-secondary: #5a6e64;
            --border: #d4ddd8;
            --success: #2d9d6f;
            --danger: #d64545;
            --warning: #e8a820;
            --info: #3a8fd4;
            --shadow: 0 2px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
            --radius: 12px;
            --radius-sm: 8px;
            --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark {
            --primary: #3cb97a;
            --primary-light: #4fd48f;
            --primary-dark: #2a8a5c;
            --gold: #f0d680;
            --gold-light: #f5e4a0;
            --gold-dark: #d4a934;
            --bg: #0d1a14;
            --card-bg: #152420;
            --text: #e0ece6;
            --text-secondary: #8fa89c;
            --border: #2a3e34;
            --shadow: 0 2px 12px rgba(0,0,0,0.3);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: background var(--transition), color var(--transition);
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }

        /* ===== HEADER ===== */
        .app-header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 50%, var(--primary-light) 100%);
            color: #fff;
            padding: 20px 20px 24px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .app-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 30% 70%, rgba(255,255,255,0.05) 0%, transparent 50%);
            pointer-events: none;
        }
        .app-header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .app-header .subtitle {
            font-size: 14px;
            opacity: 0.85;
        }
        .header-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 6px;
        }
        .header-actions button {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.25);
            color: #fff;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 16px;
            transition: background var(--transition);
            backdrop-filter: blur(4px);
        }
        .header-actions button:hover {
            background: rgba(255,255,255,0.25);
        }

        /* ===== STREAK BAR ===== */
        .streak-bar {
            display: flex;
            justify-content: center;
            gap: 16px;
            padding: 12px 20px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }
        .streak-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 600;
        }
        .streak-item .icon {
            font-size: 20px;
        }
        .streak-item .number {
            color: var(--primary);
            font-size: 18px;
        }
        .streak-fire { color: #ff6b35; }

        /* ===== CONTAINER ===== */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px 16px 80px;
        }

        /* ===== QUOTE CARD ===== */
        .quote-card {
            background: linear-gradient(135deg, var(--gold-dark) 0%, var(--gold) 100%);
            color: #1a1a0a;
            border-radius: var(--radius);
            padding: 16px 20px;
            margin-bottom: 16px;
            text-align: center;
            font-style: italic;
            font-size: 14px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: transform var(--transition);
            position: relative;
        }
        .quote-card:hover { transform: scale(1.01); }
        .quote-card .quote-source {
            font-style: normal;
            font-size: 12px;
            margin-top: 6px;
            opacity: 0.7;
        }
        .quote-card .refresh-quote {
            position: absolute;
            top: 8px;
            right: 10px;
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            opacity: 0.5;
        }
        .quote-card .refresh-quote:hover { opacity: 1; }

        /* ===== CARDS ===== */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            transition: all var(--transition);
        }
        .card:hover { box-shadow: var(--shadow-lg); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
        }
        .card-header h2 {
            font-size: 17px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-header .toggle-icon {
            font-size: 14px;
            color: var(--text-secondary);
            transition: transform var(--transition);
        }
        .card-header .toggle-icon.collapsed { transform: rotate(-90deg); }
        .card-body { transition: all var(--transition); }
        .card-body.collapsed {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            padding: 0;
            margin: 0;
        }
        .card-body:not(.collapsed) {
            max-height: 5000px;
            opacity: 1;
        }

        .section-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--primary);
            margin: 16px 0 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ===== TODAY PLAN ===== */
        .today-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--primary);
            color: #fff;
            border-radius: 20px;
            padding: 3px 10px;
            font-size: 12px;
            font-weight: 600;
        }

        .plan-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            margin: 6px 0;
            border-radius: var(--radius-sm);
            background: color-mix(in srgb, var(--primary) 5%, var(--card-bg));
            border-left: 3px solid var(--primary);
            font-size: 14px;
            transition: all var(--transition);
        }
        .plan-item:hover {
            background: color-mix(in srgb, var(--primary) 10%, var(--card-bg));
        }
        .plan-item .fortress-num {
            background: var(--primary);
            color: #fff;
            min-width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }
        .plan-item.weak-item {
            border-left-color: var(--warning);
            background: color-mix(in srgb, var(--warning) 5%, var(--card-bg));
        }
        .plan-item.weak-item .fortress-num {
            background: var(--warning);
        }

        /* ===== CHECKLIST ===== */
        .checklist-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            margin: 6px 0;
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all var(--transition);
            user-select: none;
        }
        .checklist-item:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }
        .checklist-item.checked {
            background: color-mix(in srgb, var(--success) 8%, var(--card-bg));
            border-color: var(--success);
        }
        .checklist-item.checked .check-text {
            text-decoration: line-through;
            opacity: 0.7;
        }
        .custom-checkbox {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all var(--transition);
            font-size: 12px;
        }
        .checklist-item.checked .custom-checkbox {
            background: var(--success);
            border-color: var(--success);
            color: #fff;
        }
        .check-text { font-size: 14px; flex: 1; }
        .checklist-item input[type="checkbox"] { display: none; }

        /* ===== PROGRESS ===== */
        .progress-container {
            margin: 16px 0 8px;
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--border);
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--success) 100%);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        .progress-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
            text-align: center;
        }

        /* ===== TIMER ===== */
        .timer-card {
            text-align: center;
        }
        .timer-display {
            font-size: 48px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            color: var(--primary);
            letter-spacing: 2px;
            margin: 12px 0;
        }
        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .timer-preset {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .timer-preset button {
            padding: 4px 12px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            cursor: pointer;
            font-size: 12px;
            transition: all var(--transition);
        }
        .timer-preset button:hover, .timer-preset button.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
        }
        .btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
        }
        .btn-primary {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }
        .btn-primary:hover {
            background: var(--primary-light);
            color: #fff;
            border-color: var(--primary-light);
        }
        .btn-danger {
            border-color: var(--danger);
            color: var(--danger);
        }
        .btn-danger:hover {
            background: var(--danger);
            color: #fff;
        }
        .btn-sm {
            padding: 4px 10px;
            font-size: 12px;
        }
        .btn-gold {
            background: linear-gradient(135deg, var(--gold-dark), var(--gold));
            color: #1a1a0a;
            border-color: var(--gold-dark);
        }

        /* ===== SETTINGS ===== */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }
        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .setting-item label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .setting-item input, .setting-item select {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
            transition: border-color var(--transition);
        }
        .setting-item input:focus, .setting-item select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 15%, transparent);
        }

        .toggle-setting {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--border);
            border-radius: 24px;
            transition: background var(--transition);
        }
        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: #fff;
            border-radius: 50%;
            transition: transform var(--transition);
        }
        .toggle-switch input:checked + .toggle-slider {
            background: var(--primary);
        }
        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(20px);
        }

        /* ===== FORTRESS DETAILS ===== */
        .fortress-card {
            border-left: 4px solid var(--primary);
        }
        .fortress-card[data-f="1"] { border-left-color: #4caf50; }
        .fortress-card[data-f="2"] { border-left-color: #2196f3; }
        .fortress-card[data-f="3"] { border-left-color: #9c27b0; }
        .fortress-card[data-f="4"] { border-left-color: #ff9800; }
        .fortress-card[data-f="5"] { border-left-color: #f44336; }

        .fortress-steps {
            list-style: none;
            counter-reset: step;
        }
        .fortress-steps li {
            counter-increment: step;
            padding: 6px 0 6px 32px;
            position: relative;
            font-size: 14px;
        }
        .fortress-steps li::before {
            content: counter(step);
            position: absolute;
            left: 0;
            top: 6px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: color-mix(in srgb, var(--primary) 15%, var(--card-bg));
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
        }

        /* ===== TABLE ===== */
        .table-wrap { overflow-x: auto; }
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 13px;
        }
        th, td {
            border: 1px solid var(--border);
            padding: 8px 10px;
            text-align: left;
        }
        th {
            background: color-mix(in srgb, var(--primary) 8%, var(--card-bg));
            font-weight: 600;
            color: var(--primary);
        }
        tr:hover td {
            background: color-mix(in srgb, var(--primary) 3%, var(--card-bg));
        }

        /* ===== TEXTAREA ===== */
        textarea {
            width: 100%;
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            transition: border-color var(--transition);
        }
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 15%, transparent);
        }

        /* ===== HISTORY CALENDAR ===== */
        .mini-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin: 12px 0;
        }
        .mini-calendar .cal-header {
            font-size: 11px;
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 4px 0;
        }
        .cal-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition);
            border: 1px solid transparent;
        }
        .cal-day:hover { border-color: var(--primary); }
        .cal-day.empty { cursor: default; }
        .cal-day.today { border: 2px solid var(--primary); font-weight: 700; }
        .cal-day.completed { background: var(--success); color: #fff; }
        .cal-day.partial { background: color-mix(in srgb, var(--warning) 30%, var(--card-bg)); }
        .cal-day.selected { box-shadow: 0 0 0 2px var(--gold); }

        /* ===== CELEBRATION ===== */
        .celebration-overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            pointer-events: none;
        }
        .celebration-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        .celebration-text {
            font-size: 24px;
            font-weight: 700;
            color: var(--gold);
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
            animation: celebPulse 1.5s ease infinite;
        }
        @keyframes celebPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        @keyframes fadeIn {
            from { opacity: 0; } to { opacity: 1; }
        }

        .confetti-piece {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 2px;
            z-index: 999;
            pointer-events: none;
        }

        /* ===== STATS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        .stat-box {
            text-align: center;
            padding: 14px 10px;
            border-radius: var(--radius-sm);
            background: color-mix(in srgb, var(--primary) 5%, var(--card-bg));
            border: 1px solid var(--border);
        }
        .stat-box .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }
        .stat-box .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .heatmap-row {
            display: flex;
            gap: 2px;
            margin: 2px 0;
        }
        .heat-cell {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            background: var(--border);
            transition: all var(--transition);
        }
        .heat-cell.h1 { background: color-mix(in srgb, var(--success) 25%, var(--card-bg)); }
        .heat-cell.h2 { background: color-mix(in srgb, var(--success) 50%, var(--card-bg)); }
        .heat-cell.h3 { background: color-mix(in srgb, var(--success) 75%, var(--card-bg)); }
        .heat-cell.h4 { background: var(--success); }
        .heat-cell.h5 { background: var(--primary-dark); }

        /* ===== EXPORT/IMPORT ===== */
        .export-area {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        /* ===== TABS ===== */
        .tab-bar {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        .tab-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition);
        }
        .tab-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }
        .tab-btn:hover:not(.active) {
            border-color: var(--primary);
            color: var(--primary);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

        /* ===== EDITABLE PLAN ===== */
        .editable-field {
            border: 1px dashed transparent;
            padding: 2px 4px;
            border-radius: 4px;
            cursor: text;
            transition: all var(--transition);
        }
        .editable-field:hover {
            border-color: var(--primary);
            background: color-mix(in srgb, var(--primary) 5%, var(--card-bg));
        }
        .editable-field:focus {
            outline: none;
            border-color: var(--primary);
            border-style: solid;
            background: color-mix(in srgb, var(--primary) 8%, var(--card-bg));
        }

        .day-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 16px;
            border: 1px solid var(--border);
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition);
            user-select: none;
        }
        .day-chip.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }
        .day-chip.rest {
            background: color-mix(in srgb, var(--warning) 15%, var(--card-bg));
            border-color: var(--warning);
            color: var(--gold-dark);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 640px) {
            .app-header h1 { font-size: 20px; }
            .streak-bar { gap: 10px; padding: 10px; }
            .settings-grid { grid-template-columns: 1fr; }
            .container { padding: 10px 10px 60px; }
            .timer-display { font-size: 36px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media print {
            .app-header, .streak-bar, .timer-card, .btn, .tab-bar,
            .celebration-overlay, .quote-card { display: none !important; }
            .card { box-shadow: none; break-inside: avoid; }
            .tab-content { display: block !important; }
        }

        /* ===== ANIMATIONS ===== */
        .slide-in {
            animation: slideIn 0.4s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hidden { display: none !important; }

        /* ===== NOTIFICATION DOT ===== */
        .notif-dot {
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>

<!-- Celebration Overlay -->
<div class="celebration-overlay" id="celebration">
    <div class="celebration-text" id="celebration-text">üéâ –ú–∞—à–∞–ª–ª–∞—Ö! –í—Å–µ –∫—Ä–µ–ø–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã! üéâ</div>
</div>

<!-- Header -->
<header class="app-header">
    <h1>üè∞ –ü–ª–∞–Ω —Ö–∏—Ñ–∑–∞ ‚Äî 5 –∫—Ä–µ–ø–æ—Å—Ç–µ–π</h1>
    <p class="subtitle">–°–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞—É—á–∏–≤–∞–Ω–∏–µ –ö–æ—Ä–∞–Ω–∞</p>
    <div class="header-actions">
        <button id="btn-dark" title="–¢—ë–º–Ω–∞—è —Ç–µ–º–∞">üåô</button>
        <button id="btn-print" title="–ü–µ—á–∞—Ç—å">üñ®Ô∏è</button>
    </div>
</header>

<!-- Streak Bar -->
<div class="streak-bar" id="streak-bar">
    <div class="streak-item">
        <span class="icon streak-fire">üî•</span>
        <span>–°–µ—Ä–∏—è:</span>
        <span class="number" id="streak-count">0</span>
        <span>–¥–Ω.</span>
    </div>
    <div class="streak-item">
        <span class="icon">üìñ</span>
        <span>–í—ã—É—á–µ–Ω–æ:</span>
        <span class="number" id="total-memorized-display">19</span>
        <span>—Å—Ç—Ä.</span>
    </div>
    <div class="streak-item">
        <span class="icon">üìä</span>
        <span>–°–µ–≥–æ–¥–Ω—è:</span>
        <span class="number" id="today-percent">0%</span>
    </div>
</div>

<div class="container">

    <!-- Motivational Quote -->
    <div class="quote-card" id="quote-card">
        <button class="refresh-quote" id="refresh-quote" title="–î—Ä—É–≥–∞—è —Ü–∏—Ç–∞—Ç–∞">üîÑ</button>
        <div id="quote-text">¬´–õ—É—á—à–∏–π –∏–∑ –≤–∞—Å —Ç–æ—Ç, –∫—Ç–æ –∏–∑—É—á–∞–µ—Ç –ö–æ—Ä–∞–Ω –∏ –æ–±—É—á–∞–µ—Ç –µ–º—É –¥—Ä—É–≥–∏—Ö¬ª</div>
        <div class="quote-source" id="quote-source">‚Äî –•–∞–¥–∏—Å, –°–∞—Ö–∏—Ö –∞–ª—å-–ë—É—Ö–∞—Ä–∏</div>
    </div>

    <!-- Tab Bar -->
    <div class="tab-bar">
        <button class="tab-btn active" data-tab="today">üìã –°–µ–≥–æ–¥–Ω—è</button>
        <button class="tab-btn" data-tab="fortresses">üè∞ –ö—Ä–µ–ø–æ—Å—Ç–∏</button>
        <button class="tab-btn" data-tab="plan">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä –ø–ª–∞–Ω–∞</button>
        <button class="tab-btn" data-tab="stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <button class="tab-btn" data-tab="settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <!-- ==================== TAB: TODAY ==================== -->
    <div class="tab-content active" id="tab-today">

        <!-- Today Plan -->
        <div class="card slide-in">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>üìÖ –ü–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è <span class="today-badge" id="today-badge"></span></h2>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="card-body">
                <div id="today-plan-items"></div>
            </div>
        </div>

        <!-- Checklist -->
        <div class="card slide-in">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –∫—Ä–µ–ø–æ—Å—Ç–µ–π</h2>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="card-body">
                <div id="checklist-items"></div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <p class="progress-label" id="progress-label">0 / 5 –∫—Ä–µ–ø–æ—Å—Ç–µ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</p>
                </div>
                <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn btn-sm btn-danger" id="reset-checklist">üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- Timer -->
        <div class="card slide-in timer-card">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>‚è±Ô∏è –¢–∞–π–º–µ—Ä –∑–∞—É—á–∏–≤–∞–Ω–∏—è</h2>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="card-body">
                <div class="timer-preset">
                    <button onclick="setTimer(5)">5 –º–∏–Ω</button>
                    <button onclick="setTimer(10)">10 –º–∏–Ω</button>
                    <button onclick="setTimer(15)" class="active">15 –º–∏–Ω</button>
                    <button onclick="setTimer(20)">20 –º–∏–Ω</button>
                    <button onclick="setTimer(30)">30 –º–∏–Ω</button>
                    <button onclick="setTimer(45)">45 –º–∏–Ω</button>
                </div>
                <div class="timer-display" id="timer-display">15:00</div>
                <div class="timer-controls">
                    <button class="btn btn-primary" id="timer-start">‚ñ∂ –°—Ç–∞—Ä—Ç</button>
                    <button class="btn" id="timer-pause">‚è∏ –ü–∞—É–∑–∞</button>
                    <button class="btn btn-danger" id="timer-reset">‚Ü∫ –°–±—Ä–æ—Å</button>
                </div>
            </div>
        </div>

        <!-- Notes -->
        <div class="card slide-in">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>üìù –ó–∞–º–µ—Ç–∫–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="card-body">
                <textarea id="daily-note" rows="3" placeholder="–ö–∞–∫–∏–µ –∞—è—Ç—ã —Å–µ–≥–æ–¥–Ω—è —Å–ª–æ–∂–Ω–µ–µ –≤—Å–µ–≥–æ, —á—Ç–æ —Å–ø—Ä–æ—Å–∏—Ç—å —É —É—á–∏—Ç–µ–ª—è, –º—ã—Å–ª–∏..."></textarea>
                <p style="font-size:12px; color:var(--text-secondary); margin-top:4px;">–ó–∞–º–µ—Ç–∫–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</p>
            </div>
        </div>

        <!-- Tomorrow -->
        <div class="card slide-in">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>üîÆ –ü–ª–∞–Ω –Ω–∞ –∑–∞–≤—Ç—Ä–∞</h2>
                <span class="toggle-icon collapsed">‚ñº</span>
            </div>
            <div class="card-body collapsed">
                <div id="tomorrow-plan-items"></div>
                <p style="font-size:12px; color:var(--text-secondary); margin-top:8px;">
                    –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π –ø–ª–∞–Ω, –µ—Å–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—à—å —Ç–µ–∫—É—â–∏–π –∫—Ä—É–≥.
                </p>
            </div>
        </div>
    </div>

    <!-- ==================== TAB: FORTRESSES ==================== -->
    <div class="tab-content" id="tab-fortresses">

        <!-- Fortress 1 -->
        <div class="card fortress-card slide-in" data-f="1" id="fort-1">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>üü¢ 1-—è –∫—Ä–µ–ø–æ—Å—Ç—å: –ù–æ–≤—ã–π —É—Ä–æ–∫</h2>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="card-body">
                <p><strong>–¶–µ–ª—å:</strong> –≤—ã—É—á–∏—Ç—å <span id="f1-goal">5 —Å—Ç—Ä–æ–∫</span> –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.</p>
                <ol class="fortress-steps">
                    <li>–ü—Ä–æ—á–∏—Ç–∞—Ç—å –Ω–æ–≤—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Å –º—É—Å—Ö–∞—Ñ–∞ 3‚Äì5 —Ä–∞–∑ –º–µ–¥–ª–µ–Ω–Ω–æ, —Å —Ç–∞–¥–∂–≤–∏–¥–æ–º.</li>
                    <li>–†–∞–∑–±–∏—Ç—å –Ω–∞ —á–∞—Å—Ç–∏ (–ø–æ –∞—è—Ç—É –∏–ª–∏ —Å–º—ã—Å–ª–æ–≤—ã–º –∫—É—Å–∫–∞–º).</li>
                    <li>–ö–∞–∂–¥—ã–π –∫—É—Å–æ–∫: –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å –º—É—Å—Ö–∞—Ñ–∞ ‚Üí –∑–∞—Ç–µ–º 10‚Äì15 —Ä–∞–∑ –ø–æ –ø–∞–º—è—Ç–∏.</li>
                    <li>–°–æ–µ–¥–∏–Ω–∏—Ç—å –≤–µ—Å—å —É—Ä–æ–∫ –∏ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ –ø–∞–º—è—Ç–∏ 5‚Äì10 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥.</li>
                    <li>–§–∏–Ω–∞–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –ø–æ –ø–∞–º—è—Ç–∏ ‚Äî –∫–∞–∫ –≤ –Ω–∞–º–∞–∑–µ: —Ä–æ–≤–Ω–æ, –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫.</li>
                </ol>
            </div>
        </div>

        <!-- Fortress 2 -->
        <div class="card fortress-card slide-in" data-f="2" id="fort-2">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>üîµ 2-—è –∫—Ä–µ–ø–æ—Å—Ç—å: –ë–ª–∏–∂–Ω–µ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</h2>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="card-body">
                <p><strong>–ï–∂–µ–¥–Ω–µ–≤–Ω–æ –ø–æ –ø–∞–º—è—Ç–∏:</strong></p>
                <ul style="font-size:14px; padding-left:20px;">
                    <li>–¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–≤—ã—É—á–µ–Ω–Ω–∞—è —á–∞—Å—Ç—å).</li>
                    <li id="f2-back"><strong>+ 2 –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</strong> –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ –ø–∞–º—è—Ç–∏.</li>
                </ul>
                <p id="f2-hint" style="font-size:13px; color:var(--text-secondary); margin-top:8px;"></p>
            </div>
        </div>

        <!-- Fortress 3 -->
        <div class="card fortress-card slide-in" data-f="3" id="fort-3">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>üü£ 3-—è –∫—Ä–µ–ø–æ—Å—Ç—å: –î–∞–ª—å–Ω–µ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</h2>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="card-body">
                <p>–ó–∞ <strong><span id="f3-days">6</span></strong> –¥–Ω–µ–π –ø—Ä–æ—Ö–æ–¥–∏—à—å –≤—Å–µ
                    <strong><span id="f3-total">19</span></strong> —Å—Ç—Ä–∞–Ω–∏—Ü –≤ –∫—Ä—É–≥–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è.</p>
                <p>–û–±—ä—ë–º: <strong>‚âà <span id="f3-vol">3</span> —Å—Ç—Ä./–¥–µ–Ω—å</strong>
                    <small>(–¥–∏–∞–ø–∞–∑–æ–Ω: <span id="f3-range">—Å—Ç—Ä. 1‚Äì19</span>)</small></p>
                <div id="f3-today" style="margin-top:8px;"></div>
                <div id="f3-weak" style="margin-top:4px; font-size:13px; color:var(--text-secondary);"></div>
                <div style="margin-top:12px;">
                    <button class="btn btn-sm btn-danger" id="reset-review">‚Ü∫ –ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –∫—Ä—É–≥</button>
                </div>
            </div>
        </div>

        <!-- Fortress 4 -->
        <div class="card fortress-card slide-in" data-f="4" id="fort-4">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>üü† 4-—è –∫—Ä–µ–ø–æ—Å—Ç—å: –ß—Ç–µ–Ω–∏–µ –≤ –Ω–∞–º–∞–∑–µ</h2>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="card-body">
                <ul style="font-size:14px; padding-left:20px;">
                    <li><strong>–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –Ω–∞–º–∞–∑—ã:</strong> –≤ –æ–¥–Ω–æ–º —Ä–∞–∫–∞–∞—Ç–µ —á–∏—Ç–∞–π –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3‚Äì4 —Å—Ç—Ä–∞–Ω–∏—Ü.</li>
                    <li><strong>–°—É–Ω–Ω—ã –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ:</strong> –¥–ª–∏–Ω–Ω—ã–µ –æ—Ç—Ä—ã–≤–∫–∏ (¬Ω‚Äì1 —Å—Ç—Ä. –∑–∞ —Ä–∞–∫–∞–∞—Ç), —á–∞—â–µ —Å–ª–∞–±—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.</li>
                    <li><strong>–í —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è:</strong> –ø–æ –¥–æ—Ä–æ–≥–µ, –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ ‚Äî –ø—Ä–æ–≥–æ–≤–∞—Ä–∏–≤–∞–π –ø–æ –ø–∞–º—è—Ç–∏.</li>
                </ul>
            </div>
        </div>

        <!-- Fortress 5 -->
        <div class="card fortress-card slide-in" data-f="5" id="fort-5">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>üî¥ 5-—è –∫—Ä–µ–ø–æ—Å—Ç—å: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–ª—É—à–∞–Ω–∏–µ</h2>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="card-body">
                <p class="section-title">üì¢ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞</p>
                <ul style="font-size:14px; padding-left:20px;">
                    <li>1 —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é: –ø—Ä–æ—á–∏—Ç–∞–π –ø–æ –ø–∞–º—è—Ç–∏ 5‚Äì10 —Å—Ç—Ä. –≤—Å–ª—É—Ö —É—á–∏—Ç–µ–ª—é / –Ω–∞–ø–∞—Ä–Ω–∏–∫—É / –Ω–∞ –¥–∏–∫—Ç–æ—Ñ–æ–Ω.</li>
                    <li>–†–µ–≥—É–ª—è—Ä–Ω–æ —Å–¥–∞–≤–∞–π —Å–ª–∞–±—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ –ø–æ–ª–Ω–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏.</li>
                </ul>
                <p class="section-title">üéß –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ —Å–ª—É—à–∞–Ω–∏–µ</p>
                <ul style="font-size:14px; padding-left:20px;">
                    <li>–°–ª—É—à–∞–π —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π —É—Ä–æ–∫ –∏/–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–∞–ª—å–Ω–µ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è.</li>
                    <li>–° –º—É—Å—Ö–∞—Ñ–æ–º –≤ —Ä—É–∫–∞—Ö, –∏–Ω–æ–≥–¥–∞ –ø–æ–≤—Ç–æ—Ä—è—è –∑–∞ —á—Ç–µ—Ü–æ–º.</li>
                </ul>
            </div>
        </div>

        <!-- Weak Pages -->
        <div class="card slide-in" id="weak-section">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>‚ö†Ô∏è –°–ª–∞–±—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h2>
                <span class="toggle-icon collapsed">‚ñº</span>
            </div>
            <div class="card-body collapsed">
                <p>–°–ª–∞–±—ã–µ: <strong><span id="weak-display">–Ω–µ –≤—ã–±—Ä–∞–Ω—ã</span></strong></p>
                <ul style="font-size:14px; padding-left:20px;">
                    <li>–ß–∏—Ç–∞–π –º–µ–¥–ª–µ–Ω–Ω–µ–µ –æ–±—ã—á–Ω–æ–≥–æ.</li>
                    <li>–ü–æ—Å–ª–µ —á—Ç–µ–Ω–∏—è –ø–æ –ø–∞–º—è—Ç–∏ —Å–≤–µ—Ä—è–π—Å—è —Å –º—É—Å—Ö–∞—Ñ–æ–º.</li>
                    <li>–°–ª–æ–∂–Ω—ã–µ –∞—è—Ç—ã —Ä–∞–∑–±–∏—Ä–∞–π –ø–æ —á–∞—Å—Ç—è–º –∏ –ø–æ–≤—Ç–æ—Ä—è–π 20+ —Ä–∞–∑.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ==================== TAB: PLAN EDITOR ==================== -->
    <div class="tab-content" id="tab-plan">

        <!-- Weekly Plan -->
        <div class="card slide-in">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>üìÖ –ù–µ–¥–µ–ª—å–Ω—ã–π –ø–ª–∞–Ω</h2>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="card-body">
                <p class="section-title">–î–Ω–∏ –æ—Ç–¥—ã—Ö–∞ (–±–µ–∑ –Ω–æ–≤–æ–≥–æ —É—Ä–æ–∫–∞)</p>
                <p style="font-size:13px; color:var(--text-secondary); margin-bottom:8px;">
                    –ù–∞–∂–º–∏ –Ω–∞ –¥–µ–Ω—å, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ –¥–Ω—ë–º –æ—Ç–¥—ã—Ö–∞:
                </p>
                <div id="rest-days-chips" style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:16px;"></div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>–î–µ–Ω—å</th>
                                <th>–ù–æ–≤—ã–π —É—Ä–æ–∫</th>
                                <th>–ë–ª–∏–∂–Ω–µ–µ –ø–æ–≤—Ç.</th>
                                <th>–î–∞–ª—å–Ω–µ–µ –ø–æ–≤—Ç.</th>
                            </tr>
                        </thead>
                        <tbody id="weekly-plan-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Custom Fortress Names -->
        <div class="card slide-in">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>üè∑Ô∏è –ù–∞–∑–≤–∞–Ω–∏—è –∫—Ä–µ–ø–æ—Å—Ç–µ–π</h2>
                <span class="toggle-icon collapsed">‚ñº</span>
            </div>
            <div class="card-body collapsed">
                <p style="font-size:13px; color:var(--text-secondary); margin-bottom:12px;">
                    –ú–æ–∂–µ—à—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫—Ä–µ–ø–æ—Å—Ç–∏ –ø–æ–¥ —Å–≤–æ–π —Å—Ç–∏–ª—å:
                </p>
                <div id="fortress-names-editor"></div>
                <button class="btn btn-sm" id="reset-fortress-names" style="margin-top:8px;">‚Ü∫ –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è</button>
            </div>
        </div>

        <!-- Custom Tasks -->
        <div class="card slide-in">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>‚ûï –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏</h2>
                <span class="toggle-icon collapsed">‚ñº</span>
            </div>
            <div class="card-body collapsed">
                <p style="font-size:13px; color:var(--text-secondary); margin-bottom:8px;">
                    –î–æ–±–∞–≤—å —Å–≤–æ–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤ —á–µ–∫-–ª–∏—Å—Ç:
                </p>
                <div id="custom-tasks-list"></div>
                <div style="display:flex; gap:6px; margin-top:8px;">
                    <input type="text" id="new-task-input" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞..."
                           style="flex:1; padding:8px 12px; border-radius:8px; border:1px solid var(--border);
                                  background:var(--card-bg); color:var(--text); font-size:14px;">
                    <button class="btn btn-primary btn-sm" id="add-task-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- Forecast -->
        <div class="card slide-in">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>üìà –ü—Ä–æ–≥–Ω–æ–∑ —Ä–æ—Å—Ç–∞ —Ö–∏—Ñ–∑–∞</h2>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="card-body">
                <p id="forecast-intro" style="font-size:14px; margin-bottom:10px;"></p>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr><th>–ü–µ—Ä–∏–æ–¥</th><th>–ù–æ–≤—ã–π —Ö–∏—Ñ–∑</th><th>–ü—Ä–∏—Ä–æ—Å—Ç</th><th>–ò—Ç–æ–≥–æ</th></tr>
                        </thead>
                        <tbody id="forecast-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== TAB: STATS ==================== -->
    <div class="tab-content" id="tab-stats">

        <!-- Overview Stats -->
        <div class="card slide-in">
            <div class="card-header">
                <h2>üìä –û–±–∑–æ—Ä</h2>
            </div>
            <div class="card-body">
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="stat-streak">0</div>
                        <div class="stat-label">üî• –¢–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="stat-best-streak">0</div>
                        <div class="stat-label">üèÜ –õ—É—á—à–∞—è —Å–µ—Ä–∏—è</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="stat-total-days">0</div>
                        <div class="stat-label">üìÖ –í—Å–µ–≥–æ –¥–Ω–µ–π</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="stat-completion">0%</div>
                        <div class="stat-label">‚úÖ –°—Ä–µ–¥–Ω–∏–π %</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Heatmap -->
        <div class="card slide-in">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>üóìÔ∏è –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –Ω–µ–¥–µ–ª—å)</h2>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="card-body">
                <div id="heatmap" style="overflow-x:auto;"></div>
                <div style="display:flex; gap:4px; align-items:center; margin-top:8px; font-size:11px; color:var(--text-secondary);">
                    <span>–ú–µ–Ω—å—à–µ</span>
                    <div class="heat-cell"></div>
                    <div class="heat-cell h1"></div>
                    <div class="heat-cell h2"></div>
                    <div class="heat-cell h3"></div>
                    <div class="heat-cell h4"></div>
                    <div class="heat-cell h5"></div>
                    <span>–ë–æ–ª—å—à–µ</span>
                </div>
            </div>
        </div>

        <!-- History -->
        <div class="card slide-in">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>üìú –ò—Å—Ç–æ—Ä–∏—è –¥–Ω–µ–π</h2>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="card-body">
                <!-- Mini Calendar -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <button class="btn btn-sm" id="cal-prev">‚óÄ</button>
                    <strong id="cal-month-label" style="font-size:15px;"></strong>
                    <button class="btn btn-sm" id="cal-next">‚ñ∂</button>
                </div>
                <div class="mini-calendar" id="mini-calendar"></div>
                <hr style="border:none; border-top:1px solid var(--border); margin:12px 0;">
                <div id="history-detail">
                    <p style="font-size:13px; color:var(--text-secondary);">–í—ã–±–µ—Ä–∏ –¥–µ–Ω—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.</p>
                </div>
            </div>
        </div>

        <!-- Export/Import -->
        <div class="card slide-in">
            <div class="card-header" onclick="toggleCard(this)">
                <h2>üíæ –≠–∫—Å–ø–æ—Ä—Ç / –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
                <span class="toggle-icon collapsed">‚ñº</span>
            </div>
            <div class="card-body collapsed">
                <p style="font-size:13px; color:var(--text-secondary); margin-bottom:8px;">
                    –°–æ—Ö—Ä–∞–Ω–∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª –∏–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏ –∏–∑ —Ä–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ.
                </p>
                <div class="export-area">
                    <button class="btn btn-primary btn-sm" id="export-btn">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</button>
                    <button class="btn btn-sm" id="import-btn">üì§ –ò–º–ø–æ—Ä—Ç –∏–∑ JSON</button>
                    <input type="file" id="import-file" accept=".json" class="hidden">
                    <button class="btn btn-sm btn-danger" id="clear-all-btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== TAB: SETTINGS ==================== -->
    <div class="tab-content" id="tab-settings">

        <div class="card slide-in">
            <div class="card-header">
                <h2>‚öôÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            </div>
            <div class="card-body">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>–í—Å–µ–≥–æ –≤—ã—É—á–µ–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü</label>
                        <input type="number" id="total-pages" min="1" value="19">
                    </div>
                    <div class="setting-item">
                        <label>–¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (—É—á—É –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç)</label>
                        <input type="number" id="current-page" min="1" value="19">
                    </div>
                    <div class="setting-item">
                        <label>–ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä. (—Å—Ç—Ä–æ–∫, 0‚Äì15)</label>
                        <input type="number" id="lines-on-page" min="0" max="15" value="0">
                    </div>
                    <div class="setting-item">
                        <label>–ö—Ä—É–≥ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è —Å —Å—Ç—Ä–∞–Ω–∏—Ü—ã</label>
                        <input type="number" id="start-page" min="1" value="1">
                    </div>
                    <div class="setting-item">
                        <label>–î–Ω–µ–π –Ω–∞ –æ–¥–∏–Ω –∫—Ä—É–≥ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</label>
                        <input type="number" id="cycle-days" min="1" value="6">
                    </div>
                    <div class="setting-item">
                        <label>–û–±—ä—ë–º –Ω–æ–≤–æ–≥–æ —É—Ä–æ–∫–∞</label>
                        <select id="lesson-size">
                            <option value="5">5 —Å—Ç—Ä–æ–∫</option>
                            <option value="7">7 —Å—Ç—Ä–æ–∫ (‚âà ¬Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã)</option>
                            <option value="page">–¶–µ–ª–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</option>
                        </select>
                    </div>
                    <div class="setting-item" style="grid-column: 1 / -1;">
                        <label>–°–ª–∞–±—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: 8-13, 20, 25-26)</label>
                        <input type="text" id="weak-pages" value="8-13">
                    </div>
                </div>
            </div>
        </div>

        <div class="card slide-in">
            <div class="card-header">
                <h2>üè∞ –ê–∫—Ç–∏–≤–Ω—ã–µ –∫—Ä–µ–ø–æ—Å—Ç–∏</h2>
            </div>
            <div class="card-body">
                <div class="toggle-setting">
                    <span>üü¢ 1-—è –∫—Ä–µ–ø–æ—Å—Ç—å (–Ω–æ–≤—ã–π —É—Ä–æ–∫)</span>
                    <label class="toggle-switch"><input type="checkbox" id="use-f1" checked><span class="toggle-slider"></span></label>
                </div>
                <div class="toggle-setting">
                    <span>üîµ 2-—è –∫—Ä–µ–ø–æ—Å—Ç—å (–±–ª–∏–∂–Ω–µ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ)</span>
                    <label class="toggle-switch"><input type="checkbox" id="use-f2" checked><span class="toggle-slider"></span></label>
                </div>
                <div class="toggle-setting">
                    <span>üü£ 3-—è –∫—Ä–µ–ø–æ—Å—Ç—å (–¥–∞–ª—å–Ω–µ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ)</span>
                    <label class="toggle-switch"><input type="checkbox" id="use-f3" checked><span class="toggle-slider"></span></label>
                </div>
                <div class="toggle-setting">
                    <span>üü† 4-—è –∫—Ä–µ–ø–æ—Å—Ç—å (–Ω–∞–º–∞–∑)</span>
                    <label class="toggle-switch"><input type="checkbox" id="use-f4" checked><span class="toggle-slider"></span></label>
                </div>
                <div class="toggle-setting">
                    <span>üî¥ 5-—è –∫—Ä–µ–ø–æ—Å—Ç—å (–ø—Ä–æ–≤–µ—Ä–∫–∞/—Å–ª—É—à–∞–Ω–∏–µ)</span>
                    <label class="toggle-switch"><input type="checkbox" id="use-f5" checked><span class="toggle-slider"></span></label>
                </div>
            </div>
        </div>

        <div class="card slide-in">
            <div class="card-header">
                <h2>üé® –†–µ–∂–∏–º—ã</h2>
            </div>
            <div class="card-body">
                <div class="toggle-setting">
                    <span>üîÅ –†–µ–∂–∏–º —Ç–æ–ª—å–∫–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (–±–µ–∑ –Ω–æ–≤–æ–≥–æ —É—Ä–æ–∫–∞)</span>
                    <label class="toggle-switch"><input type="checkbox" id="revision-mode"><span class="toggle-slider"></span></label>
                </div>
                <div class="toggle-setting">
                    <span>üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
                    <label class="toggle-switch"><input type="checkbox" id="dark-mode"><span class="toggle-slider"></span></label>
                </div>
                <div class="toggle-setting">
                    <span>üìê –ê–≤—Ç–æ-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–Ω–µ–π –Ω–∞ –∫—Ä—É–≥</span>
                    <label class="toggle-switch"><input type="checkbox" id="auto-cycle" checked><span class="toggle-slider"></span></label>
                </div>
                <div class="toggle-setting">
                    <span>‚ö†Ô∏è –£—á–∏—Ç—ã–≤–∞—Ç—å —Å–ª–∞–±—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</span>
                    <label class="toggle-switch"><input type="checkbox" id="use-weak" checked><span class="toggle-slider"></span></label>
                </div>
            </div>
        </div>
    </div>

</div><!-- /container -->

<script>
// ==================== CONSTANTS ====================
const LINES_PER_PAGE = 15;
const DAYS_RU = ["–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ","–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫","–í—Ç–æ—Ä–Ω–∏–∫","–°—Ä–µ–¥–∞","–ß–µ—Ç–≤–µ—Ä–≥","–ü—è—Ç–Ω–∏—Ü–∞","–°—É–±–±–æ—Ç–∞"];
const DAYS_SHORT = ["–í—Å","–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±"];
const today = new Date();
const todayKey = today.toISOString().slice(0,10);
const todayDow = today.getDay();

const QUOTES = [
    {text:"¬´–õ—É—á—à–∏–π –∏–∑ –≤–∞—Å —Ç–æ—Ç, –∫—Ç–æ –∏–∑—É—á–∞–µ—Ç –ö–æ—Ä–∞–Ω –∏ –æ–±—É—á–∞–µ—Ç –µ–º—É –¥—Ä—É–≥–∏—Ö¬ª", src:"–°–∞—Ö–∏—Ö –∞–ª—å-–ë—É—Ö–∞—Ä–∏"},
    {text:"¬´–ß–∏—Ç–∞–π—Ç–µ –ö–æ—Ä–∞–Ω, –∏–±–æ –≤ –°—É–¥–Ω—ã–π –î–µ–Ω—å –æ–Ω –ø—Ä–∏–¥—ë—Ç –∫–∞–∫ –∑–∞—Å—Ç—É–ø–Ω–∏–∫ –∑–∞ —Ç–µ—Ö, –∫—Ç–æ –µ–≥–æ —á–∏—Ç–∞–ª¬ª", src:"–°–∞—Ö–∏—Ö –ú—É—Å–ª–∏–º"},
    {text:"¬´–¢–æ–º—É, –∫—Ç–æ —á–∏—Ç–∞–µ—Ç –ö–æ—Ä–∞–Ω –∏ –∑–Ω–∞–µ—Ç –µ–≥–æ –Ω–∞–∏–∑—É—Å—Ç—å, –±—É–¥–µ—Ç —Å–∫–∞–∑–∞–Ω–æ: –ß–∏—Ç–∞–π –∏ –≤–æ–∑–≤—ã—à–∞–π—Å—è!¬ª", src:"–ê–±—É –î–∞—É–¥, –∞—Ç-–¢–∏—Ä–º–∏–∑–∏"},
    {text:"¬´–ü–æ–∏—Å—Ç–∏–Ω–µ, –ê–ª–ª–∞—Ö –≤–æ–∑–≤—ã—à–∞–µ—Ç –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º —ç—Ç–æ–π –ö–Ω–∏–≥–∏ –æ–¥–Ω–∏—Ö –ª—é–¥–µ–π –∏ –ø—Ä–∏–Ω–∏–∂–∞–µ—Ç –¥—Ä—É–≥–∏—Ö¬ª", src:"–°–∞—Ö–∏—Ö –ú—É—Å–ª–∏–º"},
    {text:"¬´–¢–æ—Ç, –∫—Ç–æ –ø—Ä–æ—á–∏—Ç–∞–ª –æ–¥–Ω—É –±—É–∫–≤—É –∏–∑ –ö–Ω–∏–≥–∏ –ê–ª–ª–∞—Ö–∞, –ø–æ–ª—É—á–∏—Ç –∑–∞ —ç—Ç–æ –æ–¥–Ω–æ –±–ª–∞–≥–æ–µ –¥–µ–ª–æ, –∞ –∑–∞ –∫–∞–∂–¥–æ–µ ‚Äî –¥–µ—Å—è—Ç–∏–∫—Ä–∞—Ç–Ω–æ–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ¬ª", src:"–∞—Ç-–¢–∏—Ä–º–∏–∑–∏"},
    {text:"¬´–û–±–ª–∞–¥–∞—Ç–µ–ª—å –ö–æ—Ä–∞–Ω–∞, –∫–æ–≥–¥–∞ –æ–Ω –≤—Å—Ç–∞—ë—Ç —Å –Ω–∏–º –Ω–æ—á—å—é –∏ –¥–Ω—ë–º –∏ –ø—Ä–∞–∫—Ç–∏–∫—É–µ—Ç –µ–≥–æ ‚Äî —Ç–æ—Ç –∑–Ω–∞–µ—Ç –µ–≥–æ¬ª", src:"–°–∞—Ö–∏—Ö –∞–ª—å-–ë—É—Ö–∞—Ä–∏, –ú—É—Å–ª–∏–º"},
    {text:"¬´–ó–∞–≤–∏–¥–æ–≤–∞—Ç—å —Å–ª–µ–¥—É–µ—Ç –ª–∏—à—å –¥–≤–æ–∏–º: —á–µ–ª–æ–≤–µ–∫—É, –∫–æ—Ç–æ—Ä–æ–º—É –ê–ª–ª–∞—Ö –¥–∞—Ä–æ–≤–∞–ª –ö–æ—Ä–∞–Ω, –∏ –æ–Ω —á–∏—Ç–∞–µ—Ç –µ–≥–æ –Ω–æ—á—å—é –∏ –¥–Ω—ë–º¬ª", src:"–°–∞—Ö–∏—Ö –∞–ª—å-–ë—É—Ö–∞—Ä–∏"},
    {text:"¬´–°–µ—Ä–¥—Ü–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω–µ—Ç –Ω–∏—á–µ–≥–æ –∏–∑ –ö–æ—Ä–∞–Ω–∞, –ø–æ–¥–æ–±–Ω–æ —Ä–∞–∑—Ä—É—à–µ–Ω–Ω–æ–º—É –¥–æ–º—É¬ª", src:"–∞—Ç-–¢–∏—Ä–º–∏–∑–∏"},
    {text:"¬´–£–∫—Ä–∞—à–∞–π—Ç–µ –ö–æ—Ä–∞–Ω —Å–≤–æ–∏–º–∏ –≥–æ–ª–æ—Å–∞–º–∏¬ª", src:"–ê–±—É –î–∞—É–¥"},
    {text:"¬´–ü–æ–≤—Ç–æ—Ä—è–π—Ç–µ –ö–æ—Ä–∞–Ω, –∏–±–æ, –∫–ª—è–Ω—É—Å—å –¢–µ–º, –≤ –ß—å–µ–π –î–ª–∞–Ω–∏ –º–æ—è –¥—É—à–∞, –æ–Ω —É—Ö–æ–¥–∏—Ç –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –≤–µ—Ä–±–ª—é–¥—ã –∏–∑ –ø—Ä–∏–≤—è–∑–∏¬ª", src:"–°–∞—Ö–∏—Ö –∞–ª—å-–ë—É—Ö–∞—Ä–∏, –ú—É—Å–ª–∏–º"},
];

const DEFAULT_FORTRESS_NAMES = [
    "–ù–æ–≤—ã–π —É—Ä–æ–∫",
    "–ë–ª–∏–∂–Ω–µ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ",
    "–î–∞–ª—å–Ω–µ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ",
    "–ß—Ç–µ–Ω–∏–µ –≤ –Ω–∞–º–∞–∑–µ",
    "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–ª—É—à–∞–Ω–∏–µ"
];

const FORTRESS_ICONS = ["üü¢","üîµ","üü£","üü†","üî¥"];

// ==================== STATE ====================
let S = {}; // settings
let reviewState = null;
let weakSet = new Set();
let timerInterval = null;
let timerSeconds = 15*60;
let timerRunning = false;
let calViewDate = new Date(today);

// ==================== DOM REFS ====================
const $ = id => document.getElementById(id);

// ==================== LOAD / SAVE ====================
function loadSettings() {
    const defs = {
        totalPages:19, currentPage:19, linesOnCurrentPage:0,
        regularStartPage:1, cycleDays:6, weakPages:"8-13",
        lessonSize:"5", darkMode:false, revisionMode:false,
        useWeakPages:true, autoCycleDays:true,
        activeFortresses:{1:true,2:true,3:true,4:true,5:true},
        restDays:[4], // Thursday by default
        fortressNames:[...DEFAULT_FORTRESS_NAMES],
        customTasks:[], // [{id,text}]
        quoteIndex: Math.floor(Math.random()*QUOTES.length)
    };
    try {
        const raw = localStorage.getItem("hifzPlanSettings");
        if (!raw) return defs;
        const d = JSON.parse(raw);
        return {...defs, ...d, activeFortresses:{...defs.activeFortresses,...(d.activeFortresses||{})}};
    } catch { return defs; }
}

function save() { localStorage.setItem("hifzPlanSettings", JSON.stringify(S)); }

function loadReview() {
    try {
        const r = localStorage.getItem("hifzPlanReview");
        return r ? JSON.parse(r) : null;
    } catch { return null; }
}
function saveReview() { if(reviewState) localStorage.setItem("hifzPlanReview", JSON.stringify(reviewState)); }

function loadChecklist(dateKey) {
    try {
        const r = localStorage.getItem("hifzCL-"+dateKey);
        return r ? JSON.parse(r) : {};
    } catch { return {}; }
}
function saveChecklist(dateKey, data) { localStorage.setItem("hifzCL-"+dateKey, JSON.stringify(data)); }

function loadNote(dateKey) { return localStorage.getItem("hifzNote-"+dateKey) || ""; }
function saveNote(dateKey, text) { localStorage.setItem("hifzNote-"+dateKey, text); }

// ==================== UTILITIES ====================
function parseWeak(text, maxP) {
    const s = new Set();
    if(!text) return s;
    text.split(",").forEach(p => {
        p = p.trim(); if(!p) return;
        const parts = p.split("-").map(x=>parseInt(x.trim(),10));
        if(parts.length===1 && !isNaN(parts[0]) && parts[0]>=1 && parts[0]<=maxP) s.add(parts[0]);
        else if(parts.length>=2) {
            let [a,b] = parts; if(isNaN(a)||isNaN(b)) return;
            if(a>b)[a,b]=[b,a]; for(let i=Math.max(1,a);i<=Math.min(maxP,b);i++) s.add(i);
        }
    });
    return s;
}

function compress(nums) {
    if(!nums||!nums.length) return "";
    const a=[...new Set(nums)].sort((x,y)=>x-y);
    const r=[]; let s=a[0],p=a[0];
    for(let i=1;i<a.length;i++){
        if(a[i]===p+1){p=a[i];}
        else{r.push(s===p?String(s):s+"‚Äì"+p);s=p=a[i];}
    }
    r.push(s===p?String(s):s+"‚Äì"+p);
    return r.join(", ");
}

function getRange() {
    const t = Math.max(1,S.totalPages||1);
    let s = Math.max(1,S.regularStartPage||1);
    if(s>t) s=t;
    return {start:s, end:t, count:t-s+1};
}

function getLinesPerDay() {
    if(S.revisionMode || !S.activeFortresses[1]) return 0;
    if(S.lessonSize==="page") return LINES_PER_PAGE;
    if(S.lessonSize==="7") return 7;
    return 5;
}

function lessonPhrase() {
    if(S.lessonSize==="7") return "7 —Å—Ç—Ä–æ–∫";
    if(S.lessonSize==="page") return "—Ü–µ–ª–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞";
    return "5 —Å—Ç—Ä–æ–∫";
}

function nearBackCount() { return S.lessonSize==="page" ? 1 : 2; }

function dateFmt(d) {
    const dd=String(d.getDate()).padStart(2,"0");
    const mm=String(d.getMonth()+1).padStart(2,"0");
    return dd+"."+mm+"."+d.getFullYear();
}

function dateKey(d) { return d.toISOString().slice(0,10); }

function calcCycleDays(pages, lesson) {
    let target = lesson==="5"?3.5:lesson==="7"?2.5:2;
    let d = Math.round(pages/target);
    return Math.max(3,Math.min(21,d));
}

// ==================== REVIEW STATE ====================
function initReview() {
    const range = getRange();
    const days = Math.max(1,S.cycleDays||1);
    const chunk = Math.max(1,Math.ceil(range.count/days));

    if(!reviewState || reviewState.lastDate !== todayKey) {
        let start = reviewState?.nextStartPage || range.start;
        if(start<range.start||start>range.end) start=range.start;
        let end = Math.min(range.end, start+chunk-1);
        reviewState = {
            lastDate:todayKey,
            todayStart:start, todayEnd:end,
            nextStartPage: end>=range.end ? range.start : end+1
        };
        saveReview();
    }
}

function getReviewToday() {
    if(!reviewState) return null;
    const isRest = S.restDays.includes(todayDow);
    if(isRest) {
        return {start:1, end:Math.max(1,S.totalPages), isRest:true};
    }
    return {start:reviewState.todayStart, end:reviewState.todayEnd, isRest:false};
}

function getReviewTomorrow() {
    const range=getRange();
    const days=Math.max(1,S.cycleDays||1);
    const chunk=Math.max(1,Math.ceil(range.count/days));
    let start = reviewState?.nextStartPage||range.start;
    if(start<range.start||start>range.end) start=range.start;
    let end = Math.min(range.end,start+chunk-1);
    return {start,end,count:end-start+1};
}

// ==================== STREAK ====================
function calcStreak() {
    let streak = 0, best = 0, totalDays = 0, totalPercent = 0;
    const d = new Date(today);
    // check today first
    const todayCL = loadChecklist(todayKey);
    const todayDone = Object.values(todayCL).filter(Boolean).length;
    const todayActive = Object.keys(S.activeFortresses).filter(k=>S.activeFortresses[k]).length;
    const todayComplete = todayActive>0 && todayDone>=todayActive;

    // go backwards
    let currentStreak = todayComplete ? 1 : 0;
    let checking = true;
    for(let i=1; i<=365; i++) {
        const dd = new Date(today);
        dd.setDate(dd.getDate()-i);
        const key = dateKey(dd);
        const cl = loadChecklist(key);
        const done = Object.values(cl).filter(Boolean).length;
        if(done>0) {
            totalDays++;
            totalPercent += Math.min(100, Math.round(done/Math.max(1,todayActive)*100));
        }
        if(checking && done >= todayActive && todayActive > 0) {
            currentStreak++;
        } else {
            checking = false;
        }
    }
    streak = currentStreak;

    // find best streak
    let tempStreak = 0;
    for(let i=0; i<=365; i++) {
        const dd = new Date(today);
        dd.setDate(dd.getDate()-i);
        const key = dateKey(dd);
        const cl = loadChecklist(key);
        const done = Object.values(cl).filter(Boolean).length;
        if(done>=todayActive && todayActive>0) {
            tempStreak++;
            if(tempStreak>best) best=tempStreak;
        } else {
            tempStreak=0;
        }
    }

    const avgPercent = totalDays>0 ? Math.round(totalPercent/totalDays) : 0;
    return {streak, best, totalDays, avgPercent};
}

// ==================== UI UPDATES ====================
function updateAll() {
    weakSet = parseWeak(S.weakPages, S.totalPages);
    initReview();
    updateQuote();
    updateTodayPlan();
    updateChecklist();
    updateFortresses();
    updateWeeklyPlan();
    updateForecast();
    updateStats();
    updateHeatmap();
    updateCalendar();
    updateCustomTasks();
    updateFortressNamesEditor();
    updateRestDaysChips();
    applyVisibility();
    updateStreakBar();

    // Sync inputs
    $("total-pages").value = S.totalPages;
    $("current-page").value = S.currentPage;
    $("lines-on-page").value = S.linesOnCurrentPage||0;
    $("start-page").value = S.regularStartPage;
    $("cycle-days").value = S.cycleDays;
    $("weak-pages").value = S.weakPages||"";
    $("lesson-size").value = S.lessonSize||"5";
    $("use-f1").checked = !!S.activeFortresses[1];
    $("use-f2").checked = !!S.activeFortresses[2];
    $("use-f3").checked = !!S.activeFortresses[3];
    $("use-f4").checked = !!S.activeFortresses[4];
    $("use-f5").checked = !!S.activeFortresses[5];
    $("revision-mode").checked = S.revisionMode;
    $("dark-mode").checked = S.darkMode;
    $("auto-cycle").checked = S.autoCycleDays;
    $("use-weak").checked = S.useWeakPages;

    if(S.revisionMode) {$("use-f1").checked=false;$("use-f1").disabled=true;S.activeFortresses[1]=false;}
    else $("use-f1").disabled=false;

    document.body.classList.toggle("dark", S.darkMode);
    $("btn-dark").textContent = S.darkMode ? "‚òÄÔ∏è" : "üåô";
    $("total-memorized-display").textContent = S.totalPages;
}

function updateQuote() {
    const q = QUOTES[S.quoteIndex % QUOTES.length];
    $("quote-text").textContent = q.text;
    $("quote-source").textContent = "‚Äî " + q.src;
}

function updateStreakBar() {
    const s = calcStreak();
    $("streak-count").textContent = s.streak;
    $("stat-streak").textContent = s.streak;
    $("stat-best-streak").textContent = s.best;
    $("stat-total-days").textContent = s.totalDays;
    $("stat-completion").textContent = s.avgPercent + "%";
}

function updateTodayPlan() {
    $("today-badge").textContent = DAYS_RU[todayDow]+", "+dateFmt(today);

    const items = [];
    const fNames = S.fortressNames || DEFAULT_FORTRESS_NAMES;

    if(S.activeFortresses[1] && !S.revisionMode) {
        const lp = getLinesPerDay();
        const page = S.currentPage;
        const used = S.linesOnCurrentPage||0;
        let desc = lessonPhrase()+" –Ω–∞ —Å—Ç—Ä. "+page;
        if(lp<LINES_PER_PAGE && lp>0) {
            const s=used+1, e=Math.min(LINES_PER_PAGE,used+lp);
            desc += " (—Å—Ç—Ä–æ–∫–∏ "+s+"‚Äì"+e+")";
        }
        items.push({num:1,text:fNames[0]+": "+desc});
    }

    if(S.activeFortresses[2]) {
        const back = nearBackCount();
        let s = Math.max(1, S.currentPage-back);
        const rangeText = s===S.currentPage ? "—Å—Ç—Ä. "+S.currentPage : "—Å—Ç—Ä. "+s+"‚Äì"+S.currentPage;
        items.push({num:2,text:fNames[1]+": "+rangeText+" –ø–æ –ø–∞–º—è—Ç–∏"});
    }

    if(S.activeFortresses[3]) {
        const r = getReviewToday();
        if(r) {
            const rangeText = r.start===r.end ? "—Å—Ç—Ä. "+r.start : "—Å—Ç—Ä. "+r.start+"‚Äì"+r.end;
            const note = r.isRest ? " (–æ–±—â–∏–π –ø—Ä–æ—Ö–æ–¥)" : " ("+(r.end-r.start+1)+" —Å—Ç—Ä.)";
            items.push({num:3,text:fNames[2]+": "+rangeText+note});
        }
    }

    if(S.activeFortresses[4]) {
        items.push({num:4,text:fNames[3]+": —á–∏—Ç–∞—Ç—å –≤—ã—É—á–µ–Ω–Ω–æ–µ –≤ –Ω–∞–º–∞–∑–µ –∏ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è"});
    }
    if(S.activeFortresses[5]) {
        items.push({num:5,text:fNames[4]+": —Å–ª—É—à–∞—Ç—å –ö–æ—Ä–∞–Ω –∏/–∏–ª–∏ —Å–¥–∞—Ç—å —á–∞—Å—Ç—å –≤—ã—É—á–µ–Ω–Ω–æ–≥–æ"});
    }

    // Weak pages info
    if(S.useWeakPages && weakSet.size>0) {
        const r = getReviewToday();
        if(r) {
            const weakInBlock = [];
            for(let p=r.start;p<=r.end;p++) if(weakSet.has(p)) weakInBlock.push(p);
            if(weakInBlock.length) {
                items.push({num:"‚ö†",text:"–°–ª–∞–±—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –±–ª–æ–∫–µ: —Å—Ç—Ä. "+compress(weakInBlock), weak:true});
            }
        }
    }

    const container = $("today-plan-items");
    container.innerHTML = items.map(it => `
        <div class="plan-item ${it.weak?'weak-item':''}">
            <span class="fortress-num">${it.num}</span>
            <span>${it.text}</span>
        </div>
    `).join("") || '<p style="color:var(--text-secondary); font-size:14px;">–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ–π –∫—Ä–µ–ø–æ—Å—Ç–∏.</p>';

    // Tomorrow
    const tmItems = [];
    if(S.activeFortresses[3]) {
        const t = getReviewTomorrow();
        const rangeText = t.start===t.end ? "—Å—Ç—Ä. "+t.start : "—Å—Ç—Ä. "+t.start+"‚Äì"+t.end;
        tmItems.push({num:3,text:"–î–∞–ª—å–Ω–µ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ: "+rangeText+" ("+t.count+" —Å—Ç—Ä.)"});
    }
    $("tomorrow-plan-items").innerHTML = tmItems.map(it => `
        <div class="plan-item">
            <span class="fortress-num">${it.num}</span>
            <span>${it.text}</span>
        </div>
    `).join("") || '<p style="color:var(--text-secondary); font-size:14px;">–ü—Ä–æ–¥–æ–ª–∂–∞–π —Ç–µ–∫—É—â–∏–π –ø–ª–∞–Ω.</p>';

    // Update today percent
    const cl = loadChecklist(todayKey);
    const active = Object.keys(S.activeFortresses).filter(k=>S.activeFortresses[k]).length + (S.customTasks||[]).length;
    const done = Object.values(cl).filter(Boolean).length;
    $("today-percent").textContent = active>0?Math.round(done/active*100)+"%":"‚Äî";
}

function updateChecklist() {
    const cl = loadChecklist(todayKey);
    const fNames = S.fortressNames || DEFAULT_FORTRESS_NAMES;
    const container = $("checklist-items");
    let html = "";

    for(let i=1;i<=5;i++) {
        if(!S.activeFortresses[i]) continue;
        const id = "fortress"+i;
        const checked = !!cl[id];
        html += `
        <div class="checklist-item ${checked?'checked':''}" data-task="${id}" onclick="toggleTask('${id}')">
            <div class="custom-checkbox">${checked?'‚úì':''}</div>
            <input type="checkbox" ${checked?'checked':''}>
            <span class="check-text">${FORTRESS_ICONS[i-1]} ${fNames[i-1]}</span>
        </div>`;
    }

    // Custom tasks
    (S.customTasks||[]).forEach(t => {
        const checked = !!cl["custom_"+t.id];
        html += `
        <div class="checklist-item ${checked?'checked':''}" data-task="custom_${t.id}" onclick="toggleTask('custom_${t.id}')">
            <div class="custom-checkbox">${checked?'‚úì':''}</div>
            <input type="checkbox" ${checked?'checked':''}>
            <span class="check-text">üìå ${escHtml(t.text)}</span>
        </div>`;
    });

    container.innerHTML = html || '<p style="color:var(--text-secondary);">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á.</p>';
    updateProgress();
}

function toggleTask(taskId) {
    const cl = loadChecklist(todayKey);
    cl[taskId] = !cl[taskId];
    saveChecklist(todayKey, cl);

    // Auto-advance lines if fortress1 completed
    if(taskId==="fortress1" && cl[taskId]) {
        const lines = getLinesPerDay();
        if(lines>0) {
            S.linesOnCurrentPage = (S.linesOnCurrentPage||0)+lines;
            normalizePage();
            save();
        }
    }

    updateChecklist();
    updateStreakBar();
    updateTodayPlan();
    checkCelebration();
}

function updateProgress() {
    const cl = loadChecklist(todayKey);
    const active = Object.keys(S.activeFortresses).filter(k=>S.activeFortresses[k]).length + (S.customTasks||[]).length;
    const done = Object.values(cl).filter(Boolean).length;
    const pct = active>0 ? Math.round(done/active*100) : 0;
    $("progress-fill").style.width = pct+"%";
    $("progress-label").textContent = done+" / "+active+" –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ("+pct+"%)";
    $("today-percent").textContent = active>0?pct+"%":"‚Äî";
}

function checkCelebration() {
    const cl = loadChecklist(todayKey);
    const active = Object.keys(S.activeFortresses).filter(k=>S.activeFortresses[k]).length + (S.customTasks||[]).length;
    const done = Object.values(cl).filter(Boolean).length;
    if(active>0 && done>=active) {
        showCelebration();
    }
}

function showCelebration() {
    const overlay = $("celebration");
    overlay.classList.add("active");
    // Confetti
    for(let i=0;i<40;i++) {
        const c = document.createElement("div");
        c.className = "confetti-piece";
        c.style.left = Math.random()*100+"vw";
        c.style.top = "-10px";
        c.style.background = ["#4caf50","#2196f3","#ff9800","#f44336","#9c27b0","#ffd700"][Math.floor(Math.random()*6)];
        c.style.transform = "rotate("+Math.random()*360+"deg)";
        document.body.appendChild(c);
        const dur = 2+Math.random()*2;
        c.animate([
            {top:"-10px",opacity:1},
            {top:"110vh",opacity:0}
        ],{duration:dur*1000,easing:"ease-in"});
        setTimeout(()=>c.remove(),dur*1000);
    }
    setTimeout(()=>overlay.classList.remove("active"),3000);
}

function normalizePage() {
    let lines = S.linesOnCurrentPage||0;
    let page = S.currentPage||1;
    while(lines>=LINES_PER_PAGE){lines-=LINES_PER_PAGE;page++;}
    if(lines<0)lines=0; if(page<1)page=1;
    S.linesOnCurrentPage=lines; S.currentPage=page;
    // Also bump totalPages if needed
    if(page>S.totalPages) S.totalPages=page;
}

function updateFortresses() {
    const fNames = S.fortressNames || DEFAULT_FORTRESS_NAMES;
    $("f1-goal").textContent = lessonPhrase();

    // F2
    const back = nearBackCount();
    const s = Math.max(1,S.currentPage-back);
    const rangeText = s===S.currentPage?"—Å—Ç—Ä. "+S.currentPage:"—Å—Ç—Ä. "+s+"‚Äì"+S.currentPage;
    $("f2-back").innerHTML = "<strong>+ "+(back===1?"1 –ø—Ä–µ–¥—ã–¥—É—â–∞—è":""+back+" –ø—Ä–µ–¥—ã–¥—É—â–∏–µ")+" —Å—Ç—Ä–∞–Ω–∏—Ü—ã</strong> –ø–æ –ø–∞–º—è—Ç–∏.";
    $("f2-hint").textContent = "–°–µ–≥–æ–¥–Ω—è –ø–æ–≤—Ç–æ—Ä–∏: "+rangeText+".";

    // F3
    const range = getRange();
    const days = Math.max(1,S.cycleDays||1);
    const chunk = Math.max(1,Math.ceil(range.count/days));
    $("f3-days").textContent = days;
    $("f3-total").textContent = range.count;
    $("f3-vol").textContent = chunk;
    $("f3-range").textContent = range.start===range.end?"—Å—Ç—Ä. "+range.start:"—Å—Ç—Ä. "+range.start+"‚Äì"+range.end;

    const rt = getReviewToday();
    if(rt) {
        const rtText = rt.start===rt.end?"—Å—Ç—Ä. "+rt.start:"—Å—Ç—Ä. "+rt.start+"‚Äì"+rt.end;
        const note = rt.isRest?" (–¥–µ–Ω—å –æ—Ç–¥—ã—Ö–∞ ‚Äî –æ–±—â–∏–π –ø—Ä–æ—Ö–æ–¥)":" ("+(rt.end-rt.start+1)+" —Å—Ç—Ä.)";
        $("f3-today").innerHTML = '<strong>–°–µ–≥–æ–¥–Ω—è: '+rtText+note+'</strong>';

        if(S.useWeakPages && weakSet.size>0) {
            const wk = [];
            for(let p=rt.start;p<=rt.end;p++) if(weakSet.has(p)) wk.push(p);
            $("f3-weak").textContent = wk.length ? "–°–ª–∞–±—ã–µ –≤ –±–ª–æ–∫–µ: —Å—Ç—Ä. "+compress(wk) : "–°–ª–∞–±—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –≤ –±–ª–æ–∫–µ –Ω–µ—Ç.";
        } else $("f3-weak").textContent = "";
    }

    // Weak display
    $("weak-display").textContent = S.useWeakPages && weakSet.size ? compress([...weakSet]) : "–Ω–µ –≤—ã–±—Ä–∞–Ω—ã";

    // Visibility
    for(let i=1;i<=5;i++) {
        const el = $("fort-"+i);
        if(el) el.style.display = S.activeFortresses[i]?"":"none";
    }
}

function applyVisibility() {
    for(let i=1;i<=5;i++) {
        const el=$("fort-"+i); if(el) el.style.display=S.activeFortresses[i]?"":"none";
    }
    $("weak-section").style.display = S.useWeakPages && weakSet.size?"":"none";
}

function updateWeeklyPlan() {
    const days = [1,2,3,4,5,6,0]; // Mon-Sun
    const fNames = S.fortressNames || DEFAULT_FORTRESS_NAMES;
    const range = getRange();
    const workDays = days.filter(d=>!S.restDays.includes(d));
    const pagesPerDay = workDays.length>0?Math.max(1,Math.ceil(range.count/workDays.length)):range.count;
    const hasNew = !S.revisionMode && S.activeFortresses[1];
    const back = nearBackCount();
    const nearLabel = "—Ç–µ–∫—É—â–∞—è + "+(back===1?"1 –ø—Ä–µ–¥.":back+" –ø—Ä–µ–¥.")+" —Å—Ç—Ä.";

    const body = $("weekly-plan-body");
    body.innerHTML = "";
    let curStart = range.start;

    days.forEach(dow => {
        const isRest = S.restDays.includes(dow);
        const name = DAYS_RU[dow];
        const isToday = dow===todayDow;

        let newCell = hasNew ? (isRest ? "–≤—ã—Ö–æ–¥–Ω–æ–π" : lessonPhrase()) : "‚Äî";
        let nearCell = S.activeFortresses[2] ? nearLabel : "‚Äî";
        let farCell;

        if(isRest) {
            farCell = "–≤—Å–µ: —Å—Ç—Ä. 1‚Äì"+S.totalPages;
        } else {
            if(curStart>range.end) farCell="‚Äî";
            else {
                const e = Math.min(range.end, curStart+pagesPerDay-1);
                farCell = curStart===e?"—Å—Ç—Ä. "+curStart:"—Å—Ç—Ä. "+curStart+"‚Äì"+e;
                curStart=e+1;
            }
        }

        const tr = document.createElement("tr");
        if(isToday) tr.style.fontWeight="700";
        tr.innerHTML = `<td>${name}${isToday?" üìç":""}</td><td>${newCell}</td><td>${nearCell}</td><td>${farCell}</td>`;
        body.appendChild(tr);
    });
}

function updateRestDaysChips() {
    const container = $("rest-days-chips");
    container.innerHTML = "";
    [1,2,3,4,5,6,0].forEach(dow => {
        const isRest = S.restDays.includes(dow);
        const chip = document.createElement("span");
        chip.className = "day-chip"+(isRest?" rest":" active");
        chip.textContent = DAYS_RU[dow];
        chip.onclick = () => {
            if(isRest) S.restDays = S.restDays.filter(d=>d!==dow);
            else S.restDays.push(dow);
            save(); updateAll();
        };
        container.appendChild(chip);
    });
}

function updateForecast() {
    const linesPerDay = getLinesPerDay();
    const horizons = [{label:"7 –¥–Ω–µ–π",days:7},{label:"30 –¥–Ω–µ–π",days:30},{label:"90 –¥–Ω–µ–π",days:90}];

    if(linesPerDay<=0) {
        $("forecast-intro").textContent = "–ù–æ–≤—ã–π —É—Ä–æ–∫ –æ—Ç–∫–ª—é—á—ë–Ω ‚Äî –ø—Ä–æ–≥–Ω–æ–∑ —Ä–∞–≤–µ–Ω 0. –í–∫–ª—é—á–∏ 1-—é –∫—Ä–µ–ø–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞.";
        $("forecast-tbody").innerHTML=""; return;
    }

    $("forecast-intro").textContent = "–ü—Ä–∏ –æ–±—ä—ë–º–µ "+lessonPhrase()+" –≤ –¥–µ–Ω—å:";
    $("forecast-tbody").innerHTML = horizons.map(h => {
        const totalLines = linesPerDay*h.days;
        const pages = Math.floor(totalLines/LINES_PER_PAGE);
        const rem = totalLines%LINES_PER_PAGE;
        const newText = pages+" —Å—Ç—Ä."+(rem?" –∏ "+rem+" —Å—Ç—Ä–æ–∫":"");
        const total = S.totalPages+pages+(rem>0?1:0);
        const dd = new Date(today); dd.setDate(dd.getDate()+h.days);
        return `<tr><td>${h.label}</td><td>${newText}</td><td>+${pages} —Å—Ç—Ä.</td><td>‚âà${total} —Å—Ç—Ä. –∫ ${dateFmt(dd)}</td></tr>`;
    }).join("");
}

function updateStats() {
    // Already done in updateStreakBar
}

function updateHeatmap() {
    const container = $("heatmap");
    const active = Object.keys(S.activeFortresses).filter(k=>S.activeFortresses[k]).length + (S.customTasks||[]).length;
    let html = '<div style="display:flex; gap:2px;">';

    // 12 weeks = 84 days, displayed as columns (weeks)
    for(let w=11;w>=0;w--) {
        html += '<div>';
        for(let d=0;d<7;d++) {
            const dd = new Date(today);
            dd.setDate(dd.getDate() - w*7 - (6-d));
            const key = dateKey(dd);
            const cl = loadChecklist(key);
            const done = Object.values(cl).filter(Boolean).length;
            let level = "";
            if(active>0 && done>0) {
                const pct = done/active;
                if(pct>=1) level="h5";
                else if(pct>=0.8) level="h4";
                else if(pct>=0.6) level="h3";
                else if(pct>=0.4) level="h2";
                else level="h1";
            }
            const isToday = key===todayKey;
            html += `<div class="heat-cell ${level}" title="${dateFmt(dd)}: ${done}/${active}" style="${isToday?'border:2px solid var(--gold);':''}"></div>`;
        }
        html += '</div>';
    }
    html += '</div>';
    container.innerHTML = html;
}

// ==================== CALENDAR ====================
function updateCalendar() {
    const y = calViewDate.getFullYear(), m = calViewDate.getMonth();
    const months = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
    $("cal-month-label").textContent = months[m]+" "+y;

    const first = new Date(y,m,1);
    const lastDay = new Date(y,m+1,0).getDate();
    let startDow = first.getDay(); // 0=Sun
    // Convert to Mon start: Mon=0,Tue=1,...Sun=6
    startDow = (startDow+6)%7;

    const active = Object.keys(S.activeFortresses).filter(k=>S.activeFortresses[k]).length + (S.customTasks||[]).length;

    let html = "";
    ["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"].forEach(d => {
        html += `<div class="cal-header">${d}</div>`;
    });
    for(let i=0;i<startDow;i++) html+=`<div class="cal-day empty"></div>`;

    for(let day=1;day<=lastDay;day++) {
        const dd = new Date(y,m,day);
        const key = dateKey(dd);
        const cl = loadChecklist(key);
        const done = Object.values(cl).filter(Boolean).length;
        const isToday = key===todayKey;
        let cls = "cal-day";
        if(isToday) cls+=" today";
        if(active>0 && done>=active) cls+=" completed";
        else if(done>0) cls+=" partial";

        html += `<div class="${cls}" onclick="showHistory('${key}')">${day}</div>`;
    }

    $("mini-calendar").innerHTML = html;
}

function showHistory(key) {
    const dd = new Date(key);
    const label = DAYS_RU[dd.getDay()]+", "+dateFmt(dd);
    const cl = loadChecklist(key);
    const note = loadNote(key);
    const fNames = S.fortressNames||DEFAULT_FORTRESS_NAMES;

    const done = Object.values(cl).filter(Boolean).length;

    if(!Object.keys(cl).length && !note) {
        $("history-detail").innerHTML = `<p><strong>${label}</strong></p><p style="color:var(--text-secondary);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç—É –¥–∞—Ç—É.</p>`;
        return;
    }

    let tasksHtml = "";
    for(let i=1;i<=5;i++) {
        const id="fortress"+i;
        const ok = cl[id];
        tasksHtml += `<div style="display:flex;gap:6px;align-items:center;margin:3px 0;">
            <span style="color:${ok?'var(--success)':'var(--text-secondary)'}">${ok?'‚úÖ':'‚¨ú'}</span>
            <span>${FORTRESS_ICONS[i-1]} ${fNames[i-1]}</span>
        </div>`;
    }
    (S.customTasks||[]).forEach(t => {
        const ok = cl["custom_"+t.id];
        tasksHtml += `<div style="display:flex;gap:6px;align-items:center;margin:3px 0;">
            <span style="color:${ok?'var(--success)':'var(--text-secondary)'}">${ok?'‚úÖ':'‚¨ú'}</span>
            <span>üìå ${escHtml(t.text)}</span>
        </div>`;
    });

    const noteHtml = note ? note.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/\n/g,"<br>") : "<em>‚Äî</em>";

    $("history-detail").innerHTML = `
        <p><strong>${label}</strong> ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: ${done}</p>
        ${tasksHtml}
        <p style="margin-top:8px;"><strong>–ó–∞–º–µ—Ç–∫–∞:</strong><br>${noteHtml}</p>
    `;

    // Highlight selected day
    document.querySelectorAll(".cal-day").forEach(el => el.classList.remove("selected"));
    document.querySelectorAll(".cal-day").forEach(el => {
        if(el.onclick && el.onclick.toString().includes(key)) el.classList.add("selected");
    });
}

// ==================== CUSTOM TASKS ====================
function updateCustomTasks() {
    const container = $("custom-tasks-list");
    if(!S.customTasks||!S.customTasks.length) {
        container.innerHTML = '<p style="font-size:13px;color:var(--text-secondary);">–ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á.</p>';
        return;
    }
    container.innerHTML = S.customTasks.map(t => `
        <div style="display:flex;align-items:center;gap:8px;margin:4px 0;">
            <span style="flex:1;font-size:14px;">üìå ${escHtml(t.text)}</span>
            <button class="btn btn-sm btn-danger" onclick="removeCustomTask('${t.id}')">‚úï</button>
        </div>
    `).join("");
}

function addCustomTask(text) {
    if(!text.trim()) return;
    if(!S.customTasks) S.customTasks=[];
    S.customTasks.push({id:Date.now().toString(36), text:text.trim()});
    save(); updateAll();
}

function removeCustomTask(id) {
    S.customTasks = (S.customTasks||[]).filter(t=>t.id!==id);
    save(); updateAll();
}

// ==================== FORTRESS NAMES ====================
function updateFortressNamesEditor() {
    const fNames = S.fortressNames||[...DEFAULT_FORTRESS_NAMES];
    const container = $("fortress-names-editor");
    container.innerHTML = fNames.map((name,i) => `
        <div class="setting-item" style="margin-bottom:8px;">
            <label>${FORTRESS_ICONS[i]} –ö—Ä–µ–ø–æ—Å—Ç—å ${i+1}</label>
            <input type="text" value="${escAttr(name)}" onchange="updateFortressName(${i},this.value)">
        </div>
    `).join("");
}

function updateFortressName(idx, value) {
    if(!S.fortressNames) S.fortressNames=[...DEFAULT_FORTRESS_NAMES];
    S.fortressNames[idx] = value.trim()||DEFAULT_FORTRESS_NAMES[idx];
    save(); updateAll();
}

function escHtml(s) { return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function escAttr(s) { return s.replace(/"/g,"&quot;").replace(/&/g,"&amp;"); }

// ==================== TIMER ====================
function setTimer(mins) {
    timerSeconds = mins*60;
    if(timerInterval){clearInterval(timerInterval);timerInterval=null;}
    timerRunning=false;
    renderTimer();
    document.querySelectorAll(".timer-preset button").forEach(b => {
        b.classList.toggle("active", b.textContent.includes(mins+" –º–∏–Ω"));
    });
}

function renderTimer() {
    const m = Math.floor(timerSeconds/60);
    const s = timerSeconds%60;
    $("timer-display").textContent = String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
}

function startTimer() {
    if(timerRunning) return;
    timerRunning=true;
    timerInterval=setInterval(()=>{
        timerSeconds--;
        if(timerSeconds<=0){
            clearInterval(timerInterval);
            timerInterval=null;
            timerRunning=false;
            timerSeconds=0;
            renderTimer();
            timerAlarm();
            return;
        }
        renderTimer();
    },1000);
}

function pauseTimer() {
    if(timerInterval){clearInterval(timerInterval);timerInterval=null;}
    timerRunning=false;
}

function resetTimerFn() {
    pauseTimer();
    const active = document.querySelector(".timer-preset button.active");
    const mins = active ? parseInt(active.textContent) : 15;
    timerSeconds = mins*60;
    renderTimer();
}

function timerAlarm() {
    // Try to play a beep
    try {
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        for(let i=0;i<3;i++) {
            const osc=ctx.createOscillator();
            const gain=ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.frequency.value=880;
            osc.type="sine";
            gain.gain.value=0.3;
            osc.start(ctx.currentTime+i*0.5);
            osc.stop(ctx.currentTime+i*0.5+0.3);
        }
    } catch {}
    alert("‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ! –ú–∞—à–∞–ª–ª–∞—Ö, –ø—Ä–æ–¥–æ–ª–∂–∞–π!");
}

// ==================== TABS ====================
function switchTab(tabId) {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.toggle("active", b.dataset.tab===tabId));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.toggle("active", c.id==="tab-"+tabId));
}

// ==================== TOGGLE CARD ====================
function toggleCard(headerEl) {
    const body = headerEl.nextElementSibling;
    const icon = headerEl.querySelector(".toggle-icon");
    body.classList.toggle("collapsed");
    if(icon) icon.classList.toggle("collapsed");
}

// ==================== EXPORT / IMPORT ====================
function exportData() {
    const data = {settings:S, review:reviewState};
    // Collect all checklist and notes
    const extras = {};
    for(let i=0;i<localStorage.length;i++){
        const key=localStorage.key(i);
        if(key.startsWith("hifzCL-")||key.startsWith("hifzNote-")){
            extras[key]=localStorage.getItem(key);
        }
    }
    data.extras = extras;
    const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download="hifz-plan-backup-"+todayKey+".json";
    a.click(); URL.revokeObjectURL(url);
}

function importData(file) {
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const data = JSON.parse(e.target.result);
            if(data.settings) { S={...S,...data.settings}; save(); }
            if(data.review) { reviewState=data.review; saveReview(); }
            if(data.extras) {
                Object.entries(data.extras).forEach(([k,v])=>localStorage.setItem(k,v));
            }
            updateAll();
            alert("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!");
        } catch { alert("‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞."); }
    };
    reader.readAsText(file);
}

// ==================== INIT ====================
(function init() {
    S = loadSettings();
    reviewState = loadReview();

    // Apply dark mode immediately
    document.body.classList.toggle("dark", S.darkMode);

    updateAll();

    // Load note
    $("daily-note").value = loadNote(todayKey);
    $("daily-note").addEventListener("input", () => saveNote(todayKey, $("daily-note").value));

    // Timer
    renderTimer();
    $("timer-start").onclick = startTimer;
    $("timer-pause").onclick = pauseTimer;
    $("timer-reset").onclick = resetTimerFn;

    // Reset checklist
    $("reset-checklist").onclick = () => {
        saveChecklist(todayKey, {});
        updateChecklist(); updateStreakBar(); updateTodayPlan();
    };

    // Reset review
    $("reset-review").onclick = () => {
        const range=getRange();
        const days=Math.max(1,S.cycleDays||1);
        const chunk=Math.max(1,Math.ceil(range.count/days));
        const start=range.start;
        const end=Math.min(range.end,start+chunk-1);
        reviewState={lastDate:todayKey,todayStart:start,todayEnd:end,
            nextStartPage:end>=range.end?range.start:end+1};
        saveReview(); updateAll();
    };

    // Tabs
    document.querySelectorAll(".tab-btn").forEach(b => {
        b.addEventListener("click", () => switchTab(b.dataset.tab));
    });

    // Dark mode
    $("btn-dark").onclick = () => { S.darkMode=!S.darkMode; save(); document.body.classList.toggle("dark",S.darkMode); $("btn-dark").textContent=S.darkMode?"‚òÄÔ∏è":"üåô"; };
    $("dark-mode").onchange = function() { S.darkMode=this.checked; save(); document.body.classList.toggle("dark",S.darkMode); $("btn-dark").textContent=S.darkMode?"‚òÄÔ∏è":"üåô"; };

    // Print
    $("btn-print").onclick = () => window.print();

    // Quote
    $("refresh-quote").onclick = (e) => { e.stopPropagation(); S.quoteIndex=(S.quoteIndex+1)%QUOTES.length; save(); updateQuote(); };

    // Settings inputs
    const settingsMap = {
        "total-pages": v => S.totalPages=Math.max(1,parseInt(v)||1),
        "current-page": v => S.currentPage=Math.max(1,parseInt(v)||1),
        "lines-on-page": v => { S.linesOnCurrentPage=Math.max(0,parseInt(v)||0); normalizePage(); },
        "start-page": v => S.regularStartPage=Math.max(1,parseInt(v)||1),
        "cycle-days": v => { S.cycleDays=Math.max(1,parseInt(v)||1); S.autoCycleDays=false; $("auto-cycle").checked=false; },
        "weak-pages": v => S.weakPages=v,
        "lesson-size": v => S.lessonSize=v,
    };
    Object.entries(settingsMap).forEach(([id,fn]) => {
        $(id).addEventListener("input", function() {
            fn(this.value);
            if(S.autoCycleDays && ["total-pages","start-page","lesson-size"].includes(id)) {
                S.cycleDays=calcCycleDays(getRange().count,S.lessonSize);
            }
            save(); reviewState=loadReview(); updateAll();
        });
    });

    // Fortress toggles
    for(let i=1;i<=5;i++) {
        $("use-f"+i).onchange = function() {
            S.activeFortresses[i]=this.checked; save(); updateAll();
        };
    }

    // Mode toggles
    $("revision-mode").onchange = function() {
        S.revisionMode=this.checked;
        if(S.revisionMode){S.activeFortresses[1]=false;}
        else{S.activeFortresses[1]=true;}
        save(); updateAll();
    };
    $("auto-cycle").onchange = function() {
        S.autoCycleDays=this.checked;
        if(S.autoCycleDays){S.cycleDays=calcCycleDays(getRange().count,S.lessonSize);save();reviewState=loadReview();}
        save(); updateAll();
    };
    $("use-weak").onchange = function() { S.useWeakPages=this.checked; save(); updateAll(); };

    // Calendar nav
    $("cal-prev").onclick = () => { calViewDate.setMonth(calViewDate.getMonth()-1); updateCalendar(); };
    $("cal-next").onclick = () => { calViewDate.setMonth(calViewDate.getMonth()+1); updateCalendar(); };

    // Custom tasks
    $("add-task-btn").onclick = () => {
        const input=$("new-task-input");
        addCustomTask(input.value); input.value="";
    };
    $("new-task-input").addEventListener("keypress", e => {
        if(e.key==="Enter"){$("add-task-btn").click();}
    });

    // Fortress names reset
    $("reset-fortress-names").onclick = () => {
        S.fortressNames=[...DEFAULT_FORTRESS_NAMES]; save(); updateAll();
    };

    // Export/Import
    $("export-btn").onclick = exportData;
    $("import-btn").onclick = () => $("import-file").click();
    $("import-file").onchange = function() { if(this.files[0]) importData(this.files[0]); this.value=""; };
    $("clear-all-btn").onclick = () => {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!")) {
            localStorage.clear(); location.reload();
        }
    };

    // Check celebration on load
    checkCelebration();
})();
</script>

</body>
</html>