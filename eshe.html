<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>План хифза — метод 5 крепостей</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            line-height: 1.5;
            color: #222;
        }
        body.dark {
            background-color: #121212;
            color: #e0e0e0;
        }
        body.compact .container {
            max-width: 100%;
            padding: 10px 10px 20px;
        }
        body.compact h1 {
            font-size: 20px;
        }
        body.compact h2 {
            margin-top: 20px;
            font-size: 18px;
        }
        body.compact .note {
            display: none;
        }
        body.compact .card {
            padding: 10px 10px;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px 15px 40px;
            background-color: #ffffff;
        }
        body.dark .container {
            background-color: #1e1e1e;
        }
        h1, h2, h3 {
            color: #16324f;
        }
        body.dark h1, body.dark h2, body.dark h3 {
            color: #cfd8ff;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
        }
        h2 {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 5px;
            margin-top: 28px;
        }
        body.dark h2 {
            border-color: #444;
        }
        p, li {
            font-size: 15px;
        }
        .note {
            background: #fff8e1;
            border-left: 4px solid #ffb300;
            padding: 10px 12px;
            margin: 15px 0;
            font-size: 14px;
        }
        body.dark .note {
            background: #333018;
            color: #fcefb8;
        }
        .card {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px 14px;
            margin: 12px 0;
            background-color: #fafafa;
        }
        body.dark .card {
            border-color: #444;
            background-color: #242424;
        }
        .checklist label {
            display: block;
            margin: 4px 0;
            cursor: pointer;
        }
        .checklist input[type="checkbox"] {
            margin-right: 6px;
        }
        small {
            color: #666;
        }
        body.dark small {
            color: #aaa;
        }
        .today-badge {
            display: inline-block;
            background: #16324f;
            color: #fff;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 12px;
            margin-left: 6px;
        }
        .reset-btn, .btn {
            margin-top: 6px;
            font-size: 13px;
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid #888;
            background: #f5f5f5;
            color: #222;
            cursor: pointer;
        }
        body.dark .reset-btn, body.dark .btn {
            background: #303030;
            color: #eee;
            border-color: #777;
        }
        .reset-btn.danger {
            border-color: #d32f2f;
            background: #fff5f5;
            color: #b71c1c;
        }
        body.dark .reset-btn.danger {
            background: #3a2323;
            color: #ffb3b3;
            border-color: #ff5252;
        }
        .settings-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 20px;
            font-size: 14px;
            margin-top: 6px;
        }
        .settings-grid label {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .settings-grid input[type="number"],
        .settings-grid input[type="text"],
        .settings-grid select {
            padding: 2px 4px;
            font-size: 14px;
        }
        .settings-grid input[type="number"] {
            width: 70px;
        }
        .settings-grid input[type="text"] {
            min-width: 220px;
            max-width: 100%;
        }
        .settings-grid select {
            min-width: 150px;
        }
        .settings-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        .settings-toggle button {
            font-size: 13px;
        }
        .hidden {
            display: none !important;
        }
        /* Прогресс-бар */
        #daily-progress {
            margin-top: 8px;
        }
        #progress-bar-outer {
            width: 100%;
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }
        #progress-bar-inner {
            width: 0%;
            height: 100%;
            background: #4caf50;
            transition: width 0.2s ease;
        }
        body.dark #progress-bar-outer {
            background: #444;
        }
        body.dark #progress-bar-inner {
            background: #81c784;
        }
        textarea {
            width: 100%;
            max-width: 100%;
            font-family: inherit;
            font-size: 14px;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        body.dark textarea {
            background: #1e1e1e;
            color: #eee;
            border-color: #555;
        }
        /* Таблицы */
        .table-wrapper {
            overflow-x: auto;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 13px;
            margin-top: 6px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 4px 6px;
            text-align: left;
        }
        th {
            background-color: #f0f0f0;
        }
        body.dark th {
            background-color: #333;
        }
        body.dark td, body.dark th {
            border-color: #555;
        }
        @media (max-width: 768px) {
            body { font-size: 15px; }
            .container { padding: 15px 10px 30px; }
        }
        @media (max-width: 640px) {
            body { font-size: 14px; }
            h1 { font-size: 20px; }
            h2 { font-size: 18px; }
        }
        @media print {
            body {
                background: #fff;
                color: #000;
            }
            .note,
            #print-btn,
            #toggle-settings,
            .reset-btn,
            .btn {
                display: none !important;
            }
            .container {
                box-shadow: none;
                border: none;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="settings-toggle">
        <h1>План хифза по методу «5 крепостей»</h1>
        <div>
            <button class="btn" id="print-btn" type="button">Печать плана</button>
        </div>
    </div>

    <p>
        Пример: выучено <strong>19 страниц</strong> с начала суры «Аль‑Бакара».<br>
        Норма нового: <strong><span id="lesson-desc-short">5 строк</span> в день</strong>.
    </p>

    <div class="note">
        Настройки сохраняются в браузере (localStorage).  
        3‑я крепость (дальнее повторение) автоматически двигается каждый новый день:
        сайт помнит, что ты повторял вчера, и даёт следующий блок сегодня.
    </div>

    <!-- Настройки -->
    <h2>Мои настройки</h2>
    <div class="card">
        <div class="settings-toggle">
            <p><small>Измени под себя — остальное сайт посчитает сам.</small></p>
            <button class="btn" id="toggle-settings" type="button">Скрыть настройки</button>
        </div>
        <div id="settings-panel">
            <div class="settings-grid">
                <label>
                    Всего выучено страниц:
                    <input type="number" id="total-pages" min="1" value="19">
                </label>
                <label>
                    Текущая страница (учу новый текст):
                    <input type="number" id="current-page" min="1" value="19">
                </label>
                <label>
                    Прогресс на текущей странице (строк):
                    <input type="number" id="lines-on-page" min="0" max="15" value="0">
                </label>
                <label>
                    Круг дальнего повторения начинать с страницы:
                    <input type="number" id="start-page" min="1" value="1">
                </label>
                <label>
                    Дней на один круг дальнего повторения:
                    <input type="number" id="cycle-days" min="1" value="6">
                </label>
                <label>
                    Объём нового урока:
                    <select id="lesson-size">
                        <option value="5">5 строк</option>
                        <option value="7">7 строк (≈ ½ страницы)</option>
                        <option value="page">целая страница</option>
                    </select>
                </label>
                <label>
                    Слабые страницы (например: 8-13, 20, 25-26):
                    <input type="text" id="weak-pages" value="8-13">
                </label>
            </div>
            <hr>
            <h3>Какие крепости я использую</h3>
            <div class="settings-grid">
                <label><input type="checkbox" id="use-f1" checked> 1‑я крепость (новый урок)</label>
                <label><input type="checkbox" id="use-f2" checked> 2‑я крепость (ближнее повторение)</label>
                <label><input type="checkbox" id="use-f3" checked> 3‑я крепость (дальнее повторение)</label>
                <label><input type="checkbox" id="use-f4" checked> 4‑я крепость (намаз)</label>
                <label><input type="checkbox" id="use-f5" checked> 5‑я крепость (проверка/слушание)</label>
            </div>
            <hr>
            <h3>Режимы и дополнительные настройки</h3>
            <div class="settings-grid">
                <label>
                    <input type="checkbox" id="revision-mode-toggle">
                    Режим только повторения (без нового урока)
                </label>
                <label>
                    <input type="checkbox" id="dark-mode-toggle">
                    Тёмная тема
                </label>
                <label>
                    <input type="checkbox" id="compact-mode-toggle">
                    Компактный режим интерфейса
                </label>
                <label>
                    <input type="checkbox" id="use-weak-pages" checked>
                    Учитывать слабые страницы в плане
                </label>
                <label>
                    <input type="checkbox" id="auto-cycle-days-toggle" checked>
                    Авто-настройка дней на круг по объёму урока
                </label>
            </div>
            <h3>Режим отображения</h3>
            <div class="settings-grid">
                <label>
                    <input type="radio" name="display-mode" id="display-mode-minimal" value="minimal">
                    Минимальный (только план, прогноз, история и чек‑лист)
                </label>
                <label>
                    <input type="radio" name="display-mode" id="display-mode-full" value="full">
                    Расширенный (все блоки)
                </label>
            </div>
        </div>
    </div>

    <!-- План на сегодня -->
    <h2>План на сегодня</h2>
    <div class="card" id="today-plan">
        <p>
            Сегодня:
            <strong><span id="today-name"></span>, <span id="today-date"></span></strong>
            <span class="today-badge">сегодня</span>
        </p>
        <ul>
            <li data-fortress="1" id="today-new">
                1‑я крепость (новый урок): 5 строк на текущей странице.
            </li>
            <li data-fortress="2" id="today-near"></li>
            <li data-fortress="3" id="today-far"></li>
            <li id="today-weak-summary"></li>
        </ul>
        <p><small>Подробности по каждой крепости — ниже.</small></p>
    </div>

    <!-- 1. Крепость -->
    <section class="fortress-block" data-fortress="1">
        <h2>
            1-я крепость: новый урок
            (<span id="lesson-desc-heading">5 строк</span> в день)
        </h2>
        <div class="card">
            <p>
                <strong>Цель:</strong> выучить
                <span id="lesson-desc-goal">5 строк</span>
                на следующей по порядку странице суры «Аль‑Бакара».
            </p>
            <ol>
                <li>
                    Прочитать новый урок
                    (<span id="lesson-desc-step1">5 строк</span>)
                    с мусхафа 3–5 раз медленно, с таджвидом.
                </li>
                <li>Разбить на маленькие части (по аяту или смысловым кускам).</li>
                <li>Каждый кусок:
                    <ul>
                        <li>несколько раз прочитать с мусхафа;</li>
                        <li>затем 10–15 раз повторить по памяти.</li>
                    </ul>
                </li>
                <li>Соединить весь объём урока и прочитать по памяти 5–10 раз подряд.</li>
                <li>В конце один раз прочитать по памяти так, как будто стоишь в намазе (ровно, без частых остановок).</li>
            </ol>
        </div>
    </section>

    <!-- 2. Крепость -->
    <section class="fortress-block" data-fortress="2">
        <h2>2-я крепость: ближнее повторение и связка</h2>
        <div class="card">
            <p><strong>Ежедневно по памяти:</strong></p>
            <ul>
                <li>Текущая страница (выученная часть этой страницы).</li>
                <li>
                    <strong>+ <span id="near-back-label">2 предыдущие страницы</span></strong>
                    полностью по памяти (если они есть).
                </li>
            </ul>
            <p id="near-review-auto">
                <strong>Подсказка:</strong> введи текущий номер страницы в настройках выше, чтобы увидеть, какие страницы повторять для 2‑й крепости.
            </p>
        </div>
    </section>

    <!-- 3. Крепость -->
    <section class="fortress-block" data-fortress="3">
        <h2>3-я крепость: дальнее повторение</h2>
        <div class="card">
            <p>
                Цель — за выбранное количество дней пройти по памяти все страницы,
                входящие в регулярный круг повторения.  
                Сайт сам делит объём на блоки и каждый новый день даёт следующий блок.
            </p>
            <p>
                Всего страниц в круге дальнего повторения:
                <strong><span id="total-pages-info">19</span></strong>.  
                Дней на круг:
                <strong><span id="cycle-days-info">6</span></strong>.  
                Примерный объём:
                <strong><span id="daily-volume-info">3</span> стр./день</strong>.<br>
                <small>Диапазон страниц круга: <span id="review-range-text">стр. 1–19</span></small>
            </p>
            <p id="third-today-main"></p>
            <p id="third-today-weak"></p>
            <button class="reset-btn danger" id="reset-review" type="button">Начать новый круг повторения с начальной страницы круга</button>
            <p><small>
                Каждый новый календарный день сайт автоматически переходит к следующему блоку страниц.
                Когда доходит до последней страницы круга, на следующий день начинает снова с начальной.
                Если сильно изменил настройки (количество страниц или дней), можно нажать кнопку
                «Начать новый круг…», чтобы пересчитать план с начала.
            </small></p>
        </div>
    </section>

    <!-- План на завтра -->
    <h2>План на завтра (предварительный)</h2>
    <div class="card" id="tomorrow-plan">
        <p id="tomorrow-far"></p>
        <p id="tomorrow-weak"></p>
        <p><small>Это ориентировочный план, если ты не меняешь настройки и продолжаешь текущий круг повторения.</small></p>
    </div>

    <!-- Прогноз роста хифза -->
    <h2>Прогноз роста хифза</h2>
    <div class="card">
        <div class="settings-toggle">
            <p><small>Если каждый день делать новый урок в выбранном объёме.</small></p>
            <button class="btn" id="toggle-forecast" type="button">Скрыть прогноз</button>
        </div>
        <div id="forecast-panel">
            <p id="forecast-intro"></p>
            <div class="table-wrapper">
                <table id="forecast-table">
                    <thead>
                    <tr>
                        <th>Период</th>
                        <th>Новый хифз</th>
                        <th>Прирост к текущему уровню</th>
                        <th>Примерный итог</th>
                    </tr>
                    </thead>
                    <tbody id="forecast-tbody"></tbody>
                </table>
            </div>
            <p id="forecast-note"><small></small></p>
        </div>
    </div>

    <!-- История дней -->
    <h2>История дней</h2>
    <div class="card" id="history-card">
        <p><small>Смотри, что было сделано и какие заметки ты оставлял в прошлые дни.</small></p>
        <div class="settings-grid">
            <button class="btn" id="history-prev" type="button">← Предыдущий день</button>
            <label>
                Дата:
                <input type="date" id="history-date">
            </label>
            <button class="btn" id="history-next" type="button">Следующий день →</button>
        </div>
        <div id="history-content">
            <p>Нет данных за выбранную дату.</p>
        </div>
    </div>

    <!-- Особый блок: слабые страницы -->
    <h3>Особое укрепление слабых страниц</h3>
    <div class="card" id="weak-section">
        <p>
            Ты отметил слабые страницы:
            <strong><span id="weak-list-info">не выбраны</span></strong>.
        </p>
        <ul>
            <li>В дни, когда в блок 3‑й крепости попадают слабые страницы:
                <ul>
                    <li>читай их медленнее обычного;</li>
                    <li>после чтения по памяти сверяйся с мусхафом;</li>
                    <li>сложные аяты разбирай на части и повторяй каждую часть по 20+ раз.</li>
                </ul>
            </li>
            <li>Отдельно можно выделять время только на слабые страницы как мини‑урок.</li>
        </ul>
    </div>

    <!-- 4. Крепость -->
    <section class="fortress-block" data-fortress="4">
        <h2>4-я крепость: чтение по памяти в намазе и в течение дня</h2>
        <div class="card">
            <p><strong>Принцип:</strong> то, что учишь и повторяешь, должно звучать в намазе.</p>
            <ul>
                <li>В обязательных намазах:
                    <ul>
                        <li>в одном из ракаатов каждого намаза читай по памяти из последних 3–4 страниц,
                            которые сейчас активно закрепляешь.</li>
                    </ul>
                </li>
                <li>В суннах и дополнительном намазе:
                    <ul>
                        <li>читать по памяти более длинные отрывки (½–1 страница за ракаат, по возможности);</li>
                        <li>чаще использовать слабые страницы для их укрепления.</li>
                    </ul>
                </li>
                <li>В течение дня:
                    <ul>
                        <li>по дороге, в ожидании и т.п. проговаривать по памяти отдельные аяты или куски по 5–10 строк.</li>
                    </ul>
                </li>
            </ul>
        </div>
    </section>

    <!-- 5. Крепость -->
    <section class="fortress-block" data-fortress="5">
        <h2>5-я крепость: проверка и слушание</h2>
        <div class="card">
            <h3>Еженедельная проверка</h3>
            <ul>
                <li>1 раз в неделю:
                    <ul>
                        <li>прочитать по памяти <strong>5–10 страниц подряд</strong> вслух:
                            <ul>
                                <li>учителю / напарнику, или</li>
                                <li>записать себя на диктофон и внимательно прослушать.</li>
                            </ul>
                        </li>
                        <li>регулярно сдавать слабые страницы до полной уверенности.</li>
                    </ul>
                </li>
            </ul>

            <h3>Ежедневное слушание</h3>
            <ul>
                <li>Каждый день слушать:
                    <ul>
                        <li>участок, который сегодня учишь как новый
                            (<span id="lesson-desc-5th">5 строк</span>), и/или</li>
                        <li>страницы, которые сегодня стоят в плане дальнего повторения.</li>
                    </ul>
                </li>
                <li>С мусхафом в руках, иногда повторяя за чтецом или после него.</li>
            </ul>
        </div>
    </section>

    <!-- Заметка на сегодня -->
    <h2>Заметка на сегодня</h2>
    <div class="card">
        <textarea id="daily-note" rows="4" placeholder="Запиши сюда, какие аяты сегодня сложнее всего, что спросить у учителя, свои ощущения и т.п."></textarea>
        <p><small>Заметка сохраняется только в этом браузере и привязана к сегодняшней дате.</small></p>
    </div>

    <!-- Итоговый дневной чек-лист -->
    <h2>Итоговый дневной чек‑лист</h2>
    <div class="card checklist" id="daily-checklist">
        <p><strong>Отметь, что сделал сегодня:</strong></p>
        <label data-fortress="1">
            <input type="checkbox" data-task-id="fortress1">
            1-я крепость: выучил(а) новый урок.
        </label>
        <label data-fortress="2">
            <input type="checkbox" data-task-id="fortress2">
            2-я крепость: повторил(а) текущую и предыдущие страницы (по плану).
        </label>
        <label data-fortress="3">
            <input type="checkbox" data-task-id="fortress3">
            3-я крепость: сделал(а) дальнее повторение страниц по плану дня.
        </label>
        <label data-fortress="4">
            <input type="checkbox" data-task-id="fortress4">
            4-я крепость: читал(а) по памяти в намазе и хотя бы один раз вне намаза.
        </label>
        <label data-fortress="5">
            <input type="checkbox" data-task-id="fortress5">
            5-я крепость: слушал(а) Коран и/или сдал(а) часть выученного.
        </label>

        <div id="daily-progress">
            <div id="progress-bar-outer">
                <div id="progress-bar-inner"></div>
            </div>
            <p id="progress-text"><small>Прогресс за сегодня: 0 / 0.</small></p>
        </div>

        <button class="reset-btn" id="reset-checklist" type="button">Сбросить чек‑лист за сегодня</button>
        <p><small>Галочки сохраняются в этом браузере и автоматически обнуляются каждый новый день.</small></p>
    </div>

    <!-- История дней -->
    <h2>История дней</h2>
    <div class="card" id="history-card">
        <p><small>Смотри, что было сделано и какие заметки ты оставлял в прошлые дни.</small></p>
        <div class="settings-grid">
            <button class="btn" id="history-prev" type="button">← Предыдущий день</button>
            <label>
                Дата:
                <input type="date" id="history-date">
            </label>
            <button class="btn" id="history-next" type="button">Следующий день →</button>
        </div>
        <div id="history-content">
            <p>Нет данных за выбранную дату.</p>
        </div>
    </div>

    <!-- Недельный план -->
    <h2>Недельный план заучивания и повторения</h2>
    <div class="card">
        <div class="settings-toggle">
            <p><small>Ориентировочный план по дням недели (четверг — выходной от нового урока).</small></p>
            <button class="btn" id="toggle-weekly-plan" type="button">Скрыть план на неделю</button>
        </div>
        <div id="weekly-plan-panel">
            <div class="table-wrapper">
                <table id="weekly-plan-table">
                    <thead>
                    <tr>
                        <th>День</th>
                        <th>Новый урок (1‑я крепость)</th>
                        <th>Ближнее повторение (2‑я крепость)</th>
                        <th>Дальнее повторение (3‑я крепость)</th>
                    </tr>
                    </thead>
                    <tbody id="weekly-plan-body"></tbody>
                </table>
            </div>
            <p><small>В четверг — выходной от нового урока: только общий проход по всему выученному (если объём позволяет).</small></p>
        </div>
    </div>

    <p><small>По мере увеличения количества выученных страниц просто измени числа в настройках — план пересчитается сам.</small></p>
</div>

<script>
    const daysRu = [
        "Воскресенье", "Понедельник", "Вторник",
        "Среда", "Четверг", "Пятница", "Суббота"
    ];
    const today = new Date();
    const todayIndex = today.getDay();
    const todayName = daysRu[todayIndex];
    const todayKey = today.toISOString().slice(0, 10);
    const LINES_PER_PAGE = 15;

    // DOM
    const totalPagesInput = document.getElementById("total-pages");
    const currentPageInput = document.getElementById("current-page");
    const linesOnPageInput = document.getElementById("lines-on-page");
    const startPageInput = document.getElementById("start-page");
    const cycleDaysInput = document.getElementById("cycle-days");
    const weakPagesInput = document.getElementById("weak-pages");
    const lessonSizeSelect = document.getElementById("lesson-size");

    const useF1 = document.getElementById("use-f1");
    const useF2 = document.getElementById("use-f2");
    const useF3 = document.getElementById("use-f3");
    const useF4 = document.getElementById("use-f4");
    const useF5 = document.getElementById("use-f5");
    const fortressToggles = { "1": useF1, "2": useF2, "3": useF3, "4": useF4, "5": useF5 };

    const revisionToggle = document.getElementById("revision-mode-toggle");
    const darkModeToggle = document.getElementById("dark-mode-toggle");
    const compactModeToggle = document.getElementById("compact-mode-toggle");
    const useWeakPagesToggle = document.getElementById("use-weak-pages");
    const autoCycleDaysToggle = document.getElementById("auto-cycle-days-toggle");

    const displayModeMinimalRadio = document.getElementById("display-mode-minimal");
    const displayModeFullRadio = document.getElementById("display-mode-full");

    const todayNameSpan = document.getElementById("today-name");
    const todayDateSpan = document.getElementById("today-date");
    const todayNewLi = document.getElementById("today-new");
    const todayNearLi = document.getElementById("today-near");
    const todayFarLi = document.getElementById("today-far");
    const todayWeakSummaryLi = document.getElementById("today-weak-summary");
    const nearReviewP = document.getElementById("near-review-auto");

    const totalPagesInfoSpan = document.getElementById("total-pages-info");
    const cycleDaysInfoSpan = document.getElementById("cycle-days-info");
    const dailyVolumeInfoSpan = document.getElementById("daily-volume-info");
    const reviewRangeTextSpan = document.getElementById("review-range-text");
    const thirdTodayMainP = document.getElementById("third-today-main");
    const thirdTodayWeakP = document.getElementById("third-today-weak");
    const resetReviewBtn = document.getElementById("reset-review");

    const tomorrowFarP = document.getElementById("tomorrow-far");
    const tomorrowWeakP = document.getElementById("tomorrow-weak");

    const weakListInfoSpan = document.getElementById("weak-list-info");

    const checklistElement = document.getElementById("daily-checklist");
    const checkboxes = checklistElement.querySelectorAll("input[type='checkbox'][data-task-id]");
    const resetChecklistBtn = document.getElementById("reset-checklist");
    const storageKeyChecklist = "quranPlanChecklist-" + todayKey;

    const progressBarInner = document.getElementById("progress-bar-inner");
    const progressText = document.getElementById("progress-text");

    const dailyNote = document.getElementById("daily-note");
    const noteKey = "quranPlanNote-" + todayKey;

    const settingsPanel = document.getElementById("settings-panel");
    const toggleSettingsBtn = document.getElementById("toggle-settings");
    const printBtn = document.getElementById("print-btn");

    const lessonDescShortSpan = document.getElementById("lesson-desc-short");
    const lessonDescHeadingSpan = document.getElementById("lesson-desc-heading");
    const lessonDescGoalSpan = document.getElementById("lesson-desc-goal");
    const lessonDescStep1Span = document.getElementById("lesson-desc-step1");
    const lessonDesc5thSpan = document.getElementById("lesson-desc-5th");
    const nearBackLabelSpan = document.getElementById("near-back-label");

    const toggleForecastBtn = document.getElementById("toggle-forecast");
    const forecastPanel = document.getElementById("forecast-panel");
    const forecastIntroP = document.getElementById("forecast-intro");
    const forecastTbody = document.getElementById("forecast-tbody");
    const forecastNoteP = document.getElementById("forecast-note");

    // История
    const historyPrevBtn = document.getElementById("history-prev");
    const historyNextBtn = document.getElementById("history-next");
    const historyDateInput = document.getElementById("history-date");
    const historyContentDiv = document.getElementById("history-content");

    // Недельный план
    const weeklyPlanToggleBtn = document.getElementById("toggle-weekly-plan");
    const weeklyPlanPanel = document.getElementById("weekly-plan-panel");
    const weeklyPlanBody = document.getElementById("weekly-plan-body");

    // State
    let settings = {};
    let weakSet = new Set();
    let reviewState = null;

    function loadSettings() {
        const isNarrow = (typeof window !== "undefined" && window.innerWidth < 700);
        const defaults = {
            totalPages: 19,
            currentPage: 19,
            linesOnCurrentPage: 0,
            regularStartPage: 1,
            cycleDays: 6,
            weakPages: "8-13",
            lessonSize: "5",
            activeFortresses: { "1": true, "2": true, "3": true, "4": true, "5": true },
            darkMode: false,
            revisionMode: false,
            settingsCollapsed: false,
            useWeakPages: true,
            compactMode: isNarrow,
            autoCycleDays: true,
            displayMode: "full"
        };
        try {
            const raw = localStorage.getItem("quranPlanSettings");
            if (!raw) return defaults;
            const data = JSON.parse(raw);
            if (!data || typeof data !== "object") return defaults;

            const out = { ...defaults };
            if (typeof data.totalPages === "number") out.totalPages = data.totalPages;
            if (typeof data.currentPage === "number") out.currentPage = data.currentPage;
            if (typeof data.linesOnCurrentPage === "number") out.linesOnCurrentPage = data.linesOnCurrentPage;
            if (typeof data.regularStartPage === "number") out.regularStartPage = data.regularStartPage;
            if (typeof data.cycleDays === "number") out.cycleDays = data.cycleDays;
            if (typeof data.weakPages === "string") out.weakPages = data.weakPages;
            if (typeof data.lessonSize === "string" && ["5","7","page"].includes(data.lessonSize)) {
                out.lessonSize = data.lessonSize;
            }
            if (typeof data.darkMode === "boolean") out.darkMode = data.darkMode;
            if (typeof data.revisionMode === "boolean") out.revisionMode = data.revisionMode;
            if (typeof data.settingsCollapsed === "boolean") out.settingsCollapsed = data.settingsCollapsed;
            if (typeof data.useWeakPages === "boolean") out.useWeakPages = data.useWeakPages;
            if (typeof data.compactMode === "boolean") out.compactMode = data.compactMode;
            if (typeof data.autoCycleDays === "boolean") out.autoCycleDays = data.autoCycleDays;
            if (typeof data.displayMode === "string" &&
                (data.displayMode === "minimal" || data.displayMode === "full")) {
                out.displayMode = data.displayMode;
            }

            if (data.activeFortresses && typeof data.activeFortresses === "object") {
                out.activeFortresses = { ...defaults.activeFortresses };
                ["1","2","3","4","5"].forEach(k => {
                    if (typeof data.activeFortresses[k] === "boolean") {
                        out.activeFortresses[k] = data.activeFortresses[k];
                    }
                });
            }
            return out;
        } catch {
            return defaults;
        }
    }

    function saveSettings() {
        localStorage.setItem("quranPlanSettings", JSON.stringify(settings));
    }

    function applySettingsToInputs() {
        totalPagesInput.value = settings.totalPages;
        currentPageInput.value = settings.currentPage;
        linesOnPageInput.value = settings.linesOnCurrentPage || 0;
        startPageInput.value = settings.regularStartPage;
        cycleDaysInput.value = settings.cycleDays;
        weakPagesInput.value = settings.weakPages || "";
        lessonSizeSelect.value = settings.lessonSize || "5";

        useF1.checked = !!settings.activeFortresses["1"];
        useF2.checked = !!settings.activeFortresses["2"];
        useF3.checked = !!settings.activeFortresses["3"];
        useF4.checked = !!settings.activeFortresses["4"];
        useF5.checked = !!settings.activeFortresses["5"];

        revisionToggle.checked = settings.revisionMode;
        darkModeToggle.checked = settings.darkMode;
        compactModeToggle.checked = settings.compactMode;
        useWeakPagesToggle.checked = settings.useWeakPages;
        autoCycleDaysToggle.checked = settings.autoCycleDays;

        if (settings.displayMode === "minimal") {
            displayModeMinimalRadio.checked = true;
        } else {
            displayModeFullRadio.checked = true;
        }

        if (settings.revisionMode) {
            useF1.checked = false;
            useF1.disabled = true;
            settings.activeFortresses["1"] = false;
        } else {
            useF1.disabled = false;
        }

        if (settings.settingsCollapsed) {
            settingsPanel.classList.add("hidden");
            toggleSettingsBtn.textContent = "Показать настройки";
        } else {
            settingsPanel.classList.remove("hidden");
            toggleSettingsBtn.textContent = "Скрыть настройки";
        }
    }

    function applyDarkMode() {
        if (settings.darkMode) document.body.classList.add("dark");
        else document.body.classList.remove("dark");
    }

    function applyCompactMode() {
        if (settings.compactMode) document.body.classList.add("compact");
        else document.body.classList.remove("compact");
    }

    function applyDisplayMode() {
        const detailed = document.querySelectorAll(".fortress-block, #weak-section");
        const minimal = settings.displayMode === "minimal";
        detailed.forEach(el => {
            if (minimal) el.classList.add("hidden");
            else el.classList.remove("hidden");
        });
    }

    function getReviewRange() {
        const totalAll = Math.max(1, parseInt(settings.totalPages, 10) || 1);
        let start = parseInt(settings.regularStartPage, 10);
        if (isNaN(start) || start < 1) start = 1;
        if (start > totalAll) start = totalAll;
        const end = totalAll;
        const count = end - start + 1;
        return { totalAll, start, end, count };
    }

    function loadReviewState() {
        try {
            const raw = localStorage.getItem("quranPlanReviewState");
            if (!raw) return null;
            const data = JSON.parse(raw);
            if (!data || typeof data !== "object") return null;
            return data;
        } catch {
            return null;
        }
    }
    function saveReviewState() {
        if (!reviewState) return;
        localStorage.setItem("quranPlanReviewState", JSON.stringify(reviewState));
    }

    function parseWeakPages(text, totalPages) {
        const set = new Set();
        if (!text) return set;
        const maxPage = Math.max(1, parseInt(totalPages, 10) || 1);
        text.split(",").forEach(part => {
            part = part.trim();
            if (!part) return;
            const rangeParts = part.split("-").map(s => s.trim());
            if (rangeParts.length === 1) {
                const n = parseInt(rangeParts[0], 10);
                if (!isNaN(n) && n >= 1 && n <= maxPage) set.add(n);
            } else {
                let start = parseInt(rangeParts[0], 10);
                let end = parseInt(rangeParts[1], 10);
                if (isNaN(start) || isNaN(end)) return;
                if (start > end) [start, end] = [end, start];
                if (end < 1) return;
                if (start < 1) start = 1;
                if (start > maxPage) return;
                if (end > maxPage) end = maxPage;
                for (let i = start; i <= end; i++) set.add(i);
            }
        });
        return set;
    }

    function compressRanges(nums) {
        if (!nums || !nums.length) return "";
        const arr = Array.from(new Set(nums)).sort((a, b) => a - b);
        const res = [];
        let start = arr[0];
        let prev = arr[0];
        for (let i = 1; i < arr.length; i++) {
            const n = arr[i];
            if (n === prev + 1) {
                prev = n;
                continue;
            } else {
                if (start === prev) res.push(String(start));
                else res.push(start + "–" + prev);
                start = prev = n;
            }
        }
        if (start === prev) res.push(String(start));
        else res.push(start + "–" + prev);
        return res.join(", ");
    }

    function normalizeLinesAndPage() {
        let lines = parseInt(settings.linesOnCurrentPage, 10);
        if (isNaN(lines) || lines < 0) lines = 0;
        let page = parseInt(settings.currentPage, 10);
        if (isNaN(page) || page < 1) page = 1;

        while (lines >= LINES_PER_PAGE) {
            lines -= LINES_PER_PAGE;
            page += 1;
        }
        settings.linesOnCurrentPage = lines;
        settings.currentPage = page;
        currentPageInput.value = page;
        linesOnPageInput.value = lines;
        saveSettings();
    }

    function initReviewForToday() {
        const range = getReviewRange();
        const days = Math.max(1, parseInt(settings.cycleDays, 10) || 1);
        const chunkLen = Math.max(1, Math.ceil(range.count / days));

        if (!reviewState || reviewState.lastDate !== todayKey) {
            let start = reviewState && reviewState.nextStartPage ? reviewState.nextStartPage : range.start;
            if (start < range.start || start > range.end) start = range.start;
            let end = Math.min(range.end, start + chunkLen - 1);
            reviewState = {
                lastDate: todayKey,
                todayStart: start,
                todayEnd: end,
                nextStartPage: (end >= range.end ? range.start : end + 1)
            };
            saveReviewState();
        } else {
            let start = reviewState.todayStart || range.start;
            let end = reviewState.todayEnd || Math.min(range.end, start + chunkLen - 1);
            if (start < range.start || start > range.end) start = range.start;
            if (end < start) end = Math.min(range.end, start + chunkLen - 1);
            if (end > range.end) end = range.end;
            reviewState.todayStart = start;
            reviewState.todayEnd = end;
            if (!reviewState.nextStartPage ||
                reviewState.nextStartPage < range.start ||
                reviewState.nextStartPage > range.end) {
                reviewState.nextStartPage = (end >= range.end ? range.start : end + 1);
            }
            saveReviewState();
        }
    }

    function getLessonPhrases() {
        const size = settings.lessonSize || "5";
        if (size === "7") {
            return { shortNom: "7 строк", shortAcc: "7 строк" };
        }
        if (size === "page") {
            return { shortNom: "целая страница", shortAcc: "целую страницу" };
        }
        return { shortNom: "5 строк", shortAcc: "5 строк" };
    }

    function updateLessonTexts() {
        const p = getLessonPhrases();
        const page = parseInt(settings.currentPage, 10) || 1;

        if (lessonDescShortSpan) lessonDescShortSpan.textContent = p.shortNom;
        if (lessonDescHeadingSpan) lessonDescHeadingSpan.textContent = p.shortNom;
        if (lessonDescGoalSpan) lessonDescGoalSpan.textContent = p.shortAcc;
        if (lessonDescStep1Span) lessonDescStep1Span.textContent = p.shortAcc;
        if (lessonDesc5thSpan) lessonDesc5thSpan.textContent = p.shortNom;

        if (todayNewLi) {
            todayNewLi.textContent =
                "1‑я крепость (новый урок): " + p.shortAcc +
                " на странице " + page + ".";
        }
    }

    function getNearBackCount() {
        const size = settings.lessonSize || "5";
        if (size === "page") return 1;
        return 2;
    }

    function updateNearBackLabel() {
        if (!nearBackLabelSpan) return;
        const count = getNearBackCount();
        if (count === 1) {
            nearBackLabelSpan.textContent = "1 предыдущую страницу";
        } else {
            nearBackLabelSpan.textContent = count + " предыдущие страницы";
        }
    }

    function buildNearReviewInfo() {
        const total = parseInt(settings.totalPages, 10) || 0;
        const current = parseInt(settings.currentPage, 10) || 0;
        if (!current || current < 1) return null;
        const back = getNearBackCount();
        let start = current - back;
        if (start < 1) start = 1;
        const text = (start === current) ? ("стр. " + current) : ("стр. " + start + "–" + current);
        let extra = "";
        if (total && current > total) {
            extra = " (внимание: текущая страница больше общего числа выученных страниц).";
        }
        return { text, extra };
    }

    function buildThirdMainInfo() {
        const range = getReviewRange();
        const days = Math.max(1, parseInt(settings.cycleDays, 10) || 1);
        const chunkLen = Math.max(1, Math.ceil(range.count / days));
        if (!reviewState || !reviewState.todayStart || !reviewState.todayEnd) return null;

        if (todayIndex === 4) { // Четверг
            const totalAll = Math.max(1, parseInt(settings.totalPages, 10) || 1);
            const rangeText = "стр. 1–" + totalAll;
            return { rangeText, count: totalAll, chunkLen, start: 1, end: totalAll, isThursdayAll: true };
        }

        const s = reviewState.todayStart;
        const e = reviewState.todayEnd;
        const count = e - s + 1;
        const rangeText = (s === e) ? ("стр. " + s) : ("стр. " + s + "–" + e);
        return { rangeText, count, chunkLen, start: s, end: e, isThursdayAll: false };
    }

    function buildThirdTomorrowInfo() {
        const range = getReviewRange();
        const days = Math.max(1, parseInt(settings.cycleDays, 10) || 1);
        const chunkLen = Math.max(1, Math.ceil(range.count / days));
        if (!reviewState) return null;

        let start = reviewState.nextStartPage || range.start;
        if (start < range.start || start > range.end) start = range.start;
        let end = Math.min(range.end, start + chunkLen - 1);
        const count = end - start + 1;
        const rangeText = (start === end) ? ("стр. " + start) : ("стр. " + start + "–" + end);
        return { rangeText, count, start, end };
    }

    function buildWeakInfoForRange(start, end) {
        if (!settings.useWeakPages) {
            return {
                message: "Учёт слабых страниц отключён (можно включить в настройках).",
                short: ""
            };
        }
        if (!weakSet || weakSet.size === 0) {
            return {
                message: "Слабые страницы не указаны. Если хочешь выделить их, заполни поле в настройках.",
                short: ""
            };
        }
        const weakToday = [];
        for (let p = start; p <= end; p++) {
            if (weakSet.has(p)) weakToday.push(p);
        }
        if (!weakToday.length) {
            return {
                message: "Слабые страницы в этот блок не попали. Всё равно следи за качеством чтения.",
                short: "Слабые страницы в этот блок не попали."
            };
        }
        const list = compressRanges(weakToday);
        return {
            message: "В этот блок попадают слабые страницы: стр. " + list + ". Сделай на них особый упор.",
            short: "Слабые страницы в блоке: стр. " + list + "."
        };
    }

    function buildWeakTodayInfo() {
        if (!reviewState) {
            return {
                message: "Слабые страницы не указаны или блок не рассчитан.",
                short: ""
            };
        }
        if (todayIndex === 4) {
            const totalAll = Math.max(1, parseInt(settings.totalPages, 10) || 1);
            return buildWeakInfoForRange(1, totalAll);
        }
        return buildWeakInfoForRange(reviewState.todayStart, reviewState.todayEnd);
    }

    function updateNearReview() {
        const info = buildNearReviewInfo();
        if (!info) {
            nearReviewP.innerHTML = "<strong>Подсказка:</strong> введи текущий номер страницы в настройках выше.";
            return;
        }
        nearReviewP.innerHTML =
            "<strong>Подсказка:</strong> сегодня для 2‑й крепости повтори по памяти: " +
            info.text + "." + info.extra;
    }

    function updateThirdFortressUI() {
        const range = getReviewRange();
        const days = Math.max(1, parseInt(settings.cycleDays, 10) || 1);
        const chunkLen = Math.max(1, Math.ceil(range.count / days));

        totalPagesInfoSpan.textContent = range.count;
        cycleDaysInfoSpan.textContent = days;
        dailyVolumeInfoSpan.textContent = chunkLen;

        if (reviewRangeTextSpan) {
            const rText = (range.start === range.end)
                ? "стр. " + range.start
                : "стр. " + range.start + "–" + range.end;
            reviewRangeTextSpan.textContent = rText;
        }

        const info = buildThirdMainInfo();
        if (!info) {
            thirdTodayMainP.textContent = "Сегодняшний блок 3‑й крепости ещё не рассчитан.";
            thirdTodayWeakP.textContent = "";
        } else {
            thirdTodayMainP.textContent =
                "Сегодня по 3‑й крепости: " + info.rangeText +
                (todayIndex === 4 ? " (общий проход)." : " (" + info.count + " стр.).");
            const weakInfo = buildWeakTodayInfo();
            thirdTodayWeakP.textContent = weakInfo.message;
        }

        if (!settings.useWeakPages) {
            weakListInfoSpan.textContent = "учёт отключён";
        } else if (!weakSet || weakSet.size === 0) {
            weakListInfoSpan.textContent = "не выбраны";
        } else {
            weakListInfoSpan.textContent = compressRanges(Array.from(weakSet));
        }

        const tomorrowInfo = buildThirdTomorrowInfo();
        if (!tomorrowInfo) {
            tomorrowFarP.textContent = "Завтрашний блок 3‑й крепости ещё не рассчитан.";
            tomorrowWeakP.textContent = "";
        } else {
            tomorrowFarP.textContent =
                "Предварительно завтра по 3‑й крепости: " +
                tomorrowInfo.rangeText + " (" + tomorrowInfo.count + " стр.).";
            const weakTomorrow = buildWeakInfoForRange(tomorrowInfo.start, tomorrowInfo.end);
            tomorrowWeakP.textContent = weakTomorrow.message;
        }
    }

    function updateTodayPlan() {
        todayNameSpan.textContent = todayName;
        const [y, m, d] = todayKey.split("-");
        todayDateSpan.textContent = d + "." + m + "." + y;

        const nearInfo = buildNearReviewInfo();
        if (nearInfo) {
            todayNearLi.textContent = "2‑я крепость (ближнее повторение): " + nearInfo.text + ".";
        } else {
            todayNearLi.textContent = "2‑я крепость (ближнее повторение): укажи текущую страницу в настройках, чтобы видеть точные номера.";
        }

        const thirdInfo = buildThirdMainInfo();
        if (thirdInfo) {
            todayFarLi.textContent =
                "3‑я крепость (дальнее повторение): " + thirdInfo.rangeText +
                (todayIndex === 4 ? " (общий проход)." : " (" + thirdInfo.count + " стр.).");
        } else {
            todayFarLi.textContent = "3‑я крепость (дальнее повторение): блок ещё не рассчитан.";
        }

        const weakInfo = buildWeakTodayInfo();
        todayWeakSummaryLi.textContent = weakInfo.short || weakInfo.message;
    }

    function applyFortressVisibility() {
        const active = settings.activeFortresses || {};
        const blocks = document.querySelectorAll(".fortress-block");
        blocks.forEach(block => {
            const num = block.getAttribute("data-fortress");
            if (!num) return;
            block.style.display = active[num] ? "" : "none";
        });
        const planItems = document.querySelectorAll("#today-plan [data-fortress]");
        planItems.forEach(item => {
            const num = item.getAttribute("data-fortress");
            item.style.display = active[num] ? "list-item" : "none";
        });
        const taskLabels = checklistElement.querySelectorAll("label[data-fortress]");
        taskLabels.forEach(label => {
            const num = label.getAttribute("data-fortress");
            label.style.display = active[num] ? "block" : "none";
        });
    }

    function updateProgressAndStats() {
        const activeList = Object.keys(settings.activeFortresses || {}).filter(
            k => settings.activeFortresses[k]
        );
        let total = activeList.length;
        let completed = 0;

        checkboxes.forEach(cb => {
            const fortNum = cb.closest("label").getAttribute("data-fortress");
            if (!fortNum) return;
            if (activeList.includes(fortNum) && cb.checked) {
                completed++;
            }
        });

        if (total > 0) {
            const percent = Math.round((completed / total) * 100);
            progressBarInner.style.width = percent + "%";
            progressText.innerHTML =
                "<small>Прогресс за сегодня: " + completed + " / " + total +
                " крепостей (" + percent + "%).</small>";
            if (completed === total) {
                progressText.innerHTML += " <small>Все активные крепости на сегодня выполнены.</small>";
            }
        } else {
            progressBarInner.style.width = "0%";
            progressText.innerHTML = "<small>Не выбрано ни одной активной крепости (проверь настройки).</small>";
        }
    }

    function getLinesPerDay() {
        if (settings.revisionMode) return 0;
        if (!settings.activeFortresses || !settings.activeFortresses["1"]) return 0;
        if (settings.lessonSize === "page") return LINES_PER_PAGE;
        if (settings.lessonSize === "7") return 7;
        return 5;
    }

    function formatDatePlusDays(days) {
        const d = new Date(today);
        d.setDate(d.getDate() + days);
        const yyyy = d.getFullYear();
        let mm = String(d.getMonth() + 1).padStart(2, "0");
        let dd = String(d.getDate()).padStart(2, "0");
        return dd + "." + mm + "." + yyyy;
    }

    function updateForecast() {
        const linesPerDay = getLinesPerDay();
        const horizons = [
            { label: "7 дней (неделя)", days: 7 },
            { label: "30 дней (≈ 1 месяц)", days: 30 },
            { label: "90 дней (≈ 3 месяца)", days: 90 }
        ];

        const p = getLessonPhrases();

        if (linesPerDay <= 0) {
            forecastIntroP.textContent =
                "Сейчас новый урок отключён (1‑я крепость не используется или включён режим только повторения), " +
                "поэтому прогноз по новому хифзу равен 0. Включи 1‑ю крепость и выбери объём урока, чтобы увидеть прогноз.";
            forecastTbody.innerHTML = "";
            forecastNoteP.innerHTML =
                "<small>Как только ты снова начнёшь новый хифз, здесь появится примерный рост за неделю, месяц и 3 месяца.</small>";
            return;
        }

        forecastIntroP.textContent =
            "При текущем объёме урока (" + p.shortNom +
            ") и ежедневном новом уроке ты добавишь к своему хифзу примерно:";

        const currentPages = parseInt(settings.totalPages, 10) || 0;

        const rows = horizons.map(h => {
            const totalLines = linesPerDay * h.days;
            const pages = Math.floor(totalLines / LINES_PER_PAGE);
            const remLines = totalLines % LINES_PER_PAGE;

            let newHifzText = totalLines + " строк";
            if (pages > 0) {
                newHifzText += " ≈ " + pages + " стр.";
                if (remLines > 0) newHifzText += " и " + remLines + " строк";
            }

            let growthText = "+" + pages + " стр.";
            if (remLines > 0) growthText += " и +" + remLines + " строк";
            growthText += " к текущему уровню.";

            const approxTotalPages = currentPages + pages + (remLines > 0 ? 1 : 0);
            const dateStr = formatDatePlusDays(h.days);
            const totalText =
                "≈ " + approxTotalPages + " стр. от начала аль‑Бакара к " + dateStr;

            return "<tr>" +
                "<td>" + h.label + "</td>" +
                "<td>" + newHifzText + "</td>" +
                "<td>" + growthText + "</td>" +
                "<td>" + totalText + "</td>" +
                "</tr>";
        });

        forecastTbody.innerHTML = rows.join("");
        forecastNoteP.innerHTML =
            "<small>Это приблизительный прогноз, исходя из того, что каждый день ты делаешь новый урок в выбранном объёме " +
            "и не пропускаешь дни. Реальный результат может отличаться — главное, чтобы темп был стабильным.</small>";
    }

    // История
    function loadHistory(dateStr) {
        historyDateInput.value = dateStr;
        const dateObj = new Date(dateStr);
        const validDate = !isNaN(dateObj.getTime());
        const [y, m, d] = dateStr.split("-");
        const dateLabel = (validDate ? daysRu[dateObj.getDay()] + ", " : "") + d + "." + m + "." + y;

        let checklistObj = {};
        try {
            const raw = localStorage.getItem("quranPlanChecklist-" + dateStr);
            if (raw) checklistObj = JSON.parse(raw) || {};
        } catch {}

        const noteText = localStorage.getItem("quranPlanNote-" + dateStr) || "";

        const totalTasks = 5;
        const completed = Object.values(checklistObj).filter(Boolean).length;

        if (!Object.keys(checklistObj).length && !noteText) {
            historyContentDiv.innerHTML =
                "<p><strong>" + dateLabel + "</strong></p>" +
                "<p>Нет сохранённых данных за эту дату.</p>";
            return;
        }

        const fortressNames = {
            fortress1: "1‑я крепость (новый урок)",
            fortress2: "2‑я крепость (ближнее повторение)",
            fortress3: "3‑я крепость (дальнее повторение)",
            fortress4: "4‑я крепость (намаз)",
            fortress5: "5‑я крепость (проверка/слушание)"
        };

        let tasksHtml = "<ul>";
        Object.entries(fortressNames).forEach(([id, label]) => {
            const done = checklistObj[id] ? "выполнено" : "—";
            tasksHtml += "<li>" + label + ": <strong>" + done + "</strong></li>";
        });
        tasksHtml += "</ul>";

        const safeNote = noteText
            ? noteText.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/\n/g, "<br>")
            : "<em>нет заметки</em>";

        historyContentDiv.innerHTML =
            "<p><strong>" + dateLabel + "</strong></p>" +
            "<p>Выполненные крепости: " + completed + " / " + totalTasks + "</p>" +
            tasksHtml +
            "<p><strong>Заметка:</strong><br>" + safeNote + "</p>";
    }

    function shiftHistory(daysDelta) {
        let current = historyDateInput.value || todayKey;
        let d = new Date(current);
        if (isNaN(d.getTime())) d = new Date(today);
        d.setDate(d.getDate() + daysDelta);
        const key = d.toISOString().slice(0, 10);
        loadHistory(key);
    }

    // Недельный план
    function updateWeeklyPlan() {
        const days = ["Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота", "Воскресенье"];
        const offDay = "Четверг";
        const workingDays = ["Понедельник", "Вторник", "Среда", "Пятница", "Суббота", "Воскресенье"];

        const range = getReviewRange();
        const pagesCount = range.count;
        const pagesPerWorkDay = Math.max(1, Math.ceil(pagesCount / workingDays.length));
        const p = getLessonPhrases();
        const hasNewLesson = !settings.revisionMode && settings.activeFortresses && settings.activeFortresses["1"];
        const nearBack = getNearBackCount();
        const nearLabel = nearBack === 1
            ? "текущая + 1 предыдущая страница"
            : "текущая + " + nearBack + " предыдущие страницы";

        weeklyPlanBody.innerHTML = "";
        let currentStart = range.start;

        days.forEach(day => {
            let newLessonCell;
            if (!hasNewLesson) {
                newLessonCell = "нет (новый урок отключён)";
            } else if (day === offDay) {
                newLessonCell = "выходной (без нового урока)";
            } else {
                newLessonCell = p.shortAcc + " на текущей странице";
            }

            let nearCell = nearLabel;

            let farCell;
            if (day === offDay) {
                const totalAll = Math.max(1, parseInt(settings.totalPages, 10) || 1);
                farCell = "все выученные страницы: стр. 1–" + totalAll;
            } else {
                if (currentStart > range.end) {
                    farCell = "повтор слабых мест или по выбору";
                } else {
                    const s = currentStart;
                    let e = currentStart + pagesPerWorkDay - 1;
                    if (e > range.end) e = range.end;
                    farCell = (s === e) ? ("стр. " + s) : ("стр. " + s + "–" + e);
                    currentStart = e + 1;
                }
            }

            const tr = document.createElement("tr");
            tr.innerHTML =
                "<td>" + day + "</td>" +
                "<td>" + newLessonCell + "</td>" +
                "<td>" + nearCell + "</td>" +
                "<td>" + farCell + "</td>";
            weeklyPlanBody.appendChild(tr);
        });
    }

    // Init
    (function init() {
        settings = loadSettings();
        applySettingsToInputs();
        normalizeLinesAndPage();
        applyDarkMode();
        applyCompactMode();
        applyDisplayMode();

        weakSet = parseWeakPages(settings.weakPages, settings.totalPages);

        reviewState = loadReviewState();
        initReviewForToday();

        updateLessonTexts();
        updateNearBackLabel();
        updateNearReview();
        updateThirdFortressUI();
        updateTodayPlan();
        applyFortressVisibility();
        updateForecast();
        updateWeeklyPlan();
        updateProgressAndStats();

        // чек-лист
        let savedChecklist = {};
        try {
            const raw = localStorage.getItem(storageKeyChecklist);
            if (raw) savedChecklist = JSON.parse(raw) || {};
        } catch {
            savedChecklist = {};
        }

        checkboxes.forEach(cb => {
            const id = cb.getAttribute("data-task-id");
            if (savedChecklist[id]) cb.checked = true;
            cb.addEventListener("change", () => {
                const wasChecked = !!savedChecklist[id];
                savedChecklist[id] = cb.checked;
                localStorage.setItem(storageKeyChecklist, JSON.stringify(savedChecklist));

                if (id === "fortress1" && cb.checked && !wasChecked) {
                    const linesAdded = getLinesPerDay();
                    if (linesAdded > 0) {
                        settings.linesOnCurrentPage = (settings.linesOnCurrentPage || 0) + linesAdded;
                        normalizeLinesAndPage();
                        updateLessonTexts();
                        updateNearReview();
                        updateWeeklyPlan();
                        updateForecast();
                        updateTodayPlan();
                    }
                }

                updateProgressAndStats();
            });
        });

        resetChecklistBtn.addEventListener("click", () => {
            checkboxes.forEach(cb => cb.checked = false);
            savedChecklist = {};
            localStorage.removeItem(storageKeyChecklist);
            updateProgressAndStats();
        });

        // заметка
        const savedNote = localStorage.getItem(noteKey);
        if (savedNote != null) dailyNote.value = savedNote;
        dailyNote.addEventListener("input", () => {
            localStorage.setItem(noteKey, dailyNote.value);
        });

        // история
        historyDateInput.value = todayKey;
        loadHistory(todayKey);
        historyDateInput.addEventListener("change", () => {
            const val = historyDateInput.value || todayKey;
            loadHistory(val);
        });
        historyPrevBtn.addEventListener("click", () => shiftHistory(-1));
        historyNextBtn.addEventListener("click", () => shiftHistory(1));

        // печать
        printBtn.addEventListener("click", () => window.print());

        // сворачивание настроек
        toggleSettingsBtn.addEventListener("click", () => {
            settings.settingsCollapsed = !settings.settingsCollapsed;
            if (settings.settingsCollapsed) {
                settingsPanel.classList.add("hidden");
                toggleSettingsBtn.textContent = "Показать настройки";
            } else {
                settingsPanel.classList.remove("hidden");
                toggleSettingsBtn.textContent = "Скрыть настройки";
            }
            saveSettings();
        });

        // сворачивание прогноза
        toggleForecastBtn.addEventListener("click", () => {
            const hidden = forecastPanel.classList.toggle("hidden");
            toggleForecastBtn.textContent = hidden ? "Показать прогноз" : "Скрыть прогноз";
        });

        // сворачивание недельного плана
        weeklyPlanToggleBtn.addEventListener("click", () => {
            const hidden = weeklyPlanPanel.classList.toggle("hidden");
            weeklyPlanToggleBtn.textContent = hidden ? "Показать план на неделю" : "Скрыть план на неделю";
        });

        // изменение числовых/текстовых настроек
        function handleSettingsInputsChange(e) {
            const totalVal = parseInt(totalPagesInput.value, 10);
            const currentVal = parseInt(currentPageInput.value, 10);
            const startVal = parseInt(startPageInput.value, 10);
            const cycleVal = parseInt(cycleDaysInput.value, 10);
            const weakVal = weakPagesInput.value || "";
            const lessonVal = lessonSizeSelect.value || "5";

            settings.totalPages = (!isNaN(totalVal) && totalVal > 0) ? totalVal : 1;
            settings.currentPage = (!isNaN(currentVal) && currentVal > 0) ? currentVal : 1;
            settings.regularStartPage = (!isNaN(startVal) && startVal > 0) ? startVal : 1;
            settings.weakPages = weakVal;
            settings.lessonSize = ["5","7","page"].includes(lessonVal) ? lessonVal : "5";

            let newCycle = settings.cycleDays || 6;

            if (e && e.target === cycleDaysInput) {
                settings.autoCycleDays = false;
                autoCycleDaysToggle.checked = false;
                if (!isNaN(cycleVal) && cycleVal > 0) newCycle = cycleVal;
                else if (!newCycle || newCycle < 1) newCycle = 1;
            } else if (settings.autoCycleDays &&
                       e && (e.target === lessonSizeSelect || e.target === totalPagesInput || e.target === startPageInput)) {
                const range = getReviewRange();
                newCycle = calcRecommendedCycleDays(range.count, settings.lessonSize);
            } else {
                if (!isNaN(cycleVal) && cycleVal > 0) newCycle = cycleVal;
                else if (!newCycle || newCycle < 1) newCycle = 1;
            }

            settings.cycleDays = newCycle;
            cycleDaysInput.value = newCycle;

            saveSettings();
            weakSet = parseWeakPages(settings.weakPages, settings.totalPages);
            normalizeLinesAndPage();

            reviewState = loadReviewState();
            initReviewForToday();

            updateLessonTexts();
            updateNearBackLabel();
            updateNearReview();
            updateThirdFortressUI();
            updateTodayPlan();
            updateForecast();
            updateWeeklyPlan();
            updateProgressAndStats();
        }

        [totalPagesInput, currentPageInput, startPageInput, cycleDaysInput,
         weakPagesInput, lessonSizeSelect]
            .forEach(input => input.addEventListener("input", handleSettingsInputsChange));

        // ручной ввод строк на странице
        linesOnPageInput.addEventListener("input", () => {
            let val = parseInt(linesOnPageInput.value, 10);
            if (isNaN(val) || val < 0) val = 0;
            settings.linesOnCurrentPage = val;
            normalizeLinesAndPage();
            updateLessonTexts();
            updateNearReview();
            updateWeeklyPlan();
            updateForecast();
            updateTodayPlan();
        });

        // вкл/выкл крепостей
        function handleFortressToggle(num) {
            const chk = fortressToggles[num];
            settings.activeFortresses[num] = !!chk.checked;
            saveSettings();
            applyFortressVisibility();
            updateForecast();
            updateWeeklyPlan();
            updateProgressAndStats();
            updateTodayPlan();
        }
        ["1","2","3","4","5"].forEach(num => {
            fortressToggles[num].addEventListener("change", () => handleFortressToggle(num));
        });

        // режим только повторения
        revisionToggle.addEventListener("change", () => {
            settings.revisionMode = revisionToggle.checked;
            if (settings.revisionMode) {
                settings.activeFortresses["1"] = false;
                useF1.checked = false;
                useF1.disabled = true;
            } else {
                useF1.disabled = false;
                settings.activeFortresses["1"] = true;
                useF1.checked = true;
            }
            saveSettings();
            applyFortressVisibility();
            updateNearReview();
            updateThirdFortressUI();
            updateTodayPlan();
            updateForecast();
            updateWeeklyPlan();
            updateProgressAndStats();
        });

        // тёмная тема
        darkModeToggle.addEventListener("change", () => {
            settings.darkMode = darkModeToggle.checked;
            saveSettings();
            applyDarkMode();
        });

        // компактный режим
        compactModeToggle.addEventListener("change", () => {
            settings.compactMode = compactModeToggle.checked;
            saveSettings();
            applyCompactMode();
        });

        // учёт слабых страниц
        useWeakPagesToggle.addEventListener("change", () => {
            settings.useWeakPages = useWeakPagesToggle.checked;
            saveSettings();
            updateThirdFortressUI();
            updateTodayPlan();
        });

        // авто-настройка дней на круг
        function calcRecommendedCycleDays(pagesCount, lessonSize) {
            const pages = Math.max(1, pagesCount || 1);
            let targetPerDay;
            if (lessonSize === "5") {
                targetPerDay = 3.5;
            } else if (lessonSize === "7") {
                targetPerDay = 2.5;
            } else {
                targetPerDay = 2;
            }
            let days = Math.round(pages / targetPerDay);
            if (days < 3) days = 3;
            if (days > 21) days = 21;
            return days;
        }

        autoCycleDaysToggle.addEventListener("change", () => {
            settings.autoCycleDays = autoCycleDaysToggle.checked;
            saveSettings();
            if (settings.autoCycleDays) {
                const range = getReviewRange();
                const newCycle = calcRecommendedCycleDays(range.count, settings.lessonSize);
                settings.cycleDays = newCycle;
                cycleDaysInput.value = newCycle;
                saveSettings();
                reviewState = loadReviewState();
                initReviewForToday();
                updateThirdFortressUI();
                updateTodayPlan();
                updateForecast();
                updateWeeklyPlan();
                updateProgressAndStats();
            }
        });

        // новый круг повторения
        resetReviewBtn.addEventListener("click", () => {
            const range = getReviewRange();
            const days = Math.max(1, parseInt(settings.cycleDays, 10) || 1);
            const chunkLen = Math.max(1, Math.ceil(range.count / days));
            const start = range.start;
            const end = Math.min(range.end, start + chunkLen - 1);
            reviewState = {
                lastDate: todayKey,
                todayStart: start,
                todayEnd: end,
                nextStartPage: (end >= range.end ? range.start : end + 1)
            };
            saveReviewState();
            updateThirdFortressUI();
            updateTodayPlan();
            updateForecast();
            updateWeeklyPlan();
        });

        // режим отображения
        displayModeMinimalRadio.addEventListener("change", () => {
            if (displayModeMinimalRadio.checked) {
                settings.displayMode = "minimal";
                saveSettings();
                applyDisplayMode();
            }
        });
        displayModeFullRadio.addEventListener("change", () => {
            if (displayModeFullRadio.checked) {
                settings.displayMode = "full";
                saveSettings();
                applyDisplayMode();
            }
        });
    })();
</script>
</body>
</html>